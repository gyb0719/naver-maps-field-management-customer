<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .sync-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .sync-indicator.offline {
            background: #6c757d;
        }
        .sync-indicator.syncing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        .sync-indicator.synced {
            background: #28a745;
        }
        .sync-indicator.error {
            background: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- ë™ê¸°í™” ìƒíƒœ í‘œì‹œ -->
        <div class="test-section">
            <h3>ğŸ”Œ ë™ê¸°í™” ìƒíƒœ</h3>
            <div id="syncStatus" class="status info">
                <span class="sync-indicator offline" id="syncIndicator"></span>
                <span id="syncText">ì´ˆê¸°í™” ì¤‘...</span>
            </div>
            <button onclick="refreshStatus()">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="runDiagnostics()">ì§„ë‹¨ ì‹¤í–‰</button>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± -->
        <div class="test-section">
            <h3>ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</h3>
            <button onclick="generateTestParcels(1)">í•„ì§€ 1ê°œ ìƒì„±</button>
            <button onclick="generateTestParcels(5)">í•„ì§€ 5ê°œ ìƒì„±</button>
            <button onclick="generateTestParcels(10)">í•„ì§€ 10ê°œ ìƒì„±</button>
            <button onclick="clearTestData()" class="danger">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</button>
        </div>

        <!-- ìˆ˜ë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>âš¡ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</h3>
            <button onclick="testAutoSync()">ìë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
            <button onclick="testManualSync()">ìˆ˜ë™ ë™ê¸°í™”</button>
            <button onclick="testBatchSync()">ë°°ì¹˜ ë™ê¸°í™” (í° ë°ì´í„°)</button>
            <button onclick="testGoogleBackup()">Google Sheets ë°±ì—…</button>
        </div>

        <!-- ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜ -->
        <div class="test-section">
            <h3>ğŸš¨ ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h3>
            <button onclick="simulateNetworkError()">ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬</button>
            <button onclick="simulateDataCorruption()">ë°ì´í„° ì†ìƒ</button>
            <button onclick="testCircuitBreaker()">íšŒë¡œ ì°¨ë‹¨ê¸°</button>
            <button onclick="recoverFromError()">ì—ëŸ¬ ë³µêµ¬</button>
        </div>

        <!-- ì‹¤ì‹œê°„ í†µê³„ -->
        <div class="test-section">
            <h3>ğŸ“Š ì‹¤ì‹œê°„ í†µê³„</h3>
            <div class="stats-grid" id="statsGrid">
                <!-- í†µê³„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            <button onclick="updateStats()">í†µê³„ ì—…ë°ì´íŠ¸</button>
        </div>

        <!-- ë¡œê·¸ ì¶œë ¥ -->
        <div class="test-section">
            <h3>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="logOutput" class="log"></div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button onclick="exportLog()">ë¡œê·¸ ë‚´ë³´ë‚´ê¸°</button>
        </div>
    </div>

    <!-- DataManager ë¡œë“œ -->
    <script src="/js/data-manager.js"></script>

    <script>
        // ë¡œê·¸ ì‹œìŠ¤í…œ
        const log = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logOutput');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            console.log(logEntry.trim());
        };

        // DataManager ì´ˆê¸°í™” ëŒ€ê¸°
        const waitForDataManager = () => {
            return new Promise((resolve) => {
                if (window.dataManager) {
                    resolve(window.dataManager);
                } else {
                    setTimeout(() => waitForDataManager().then(resolve), 100);
                }
            });
        };

        // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        const updateSyncStatus = (status, message) => {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            const statusDiv = document.getElementById('syncStatus');
            
            indicator.className = `sync-indicator ${status}`;
            text.textContent = message;
            
            // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
            statusDiv.className = 'status ' + (
                status === 'error' ? 'error' : 
                status === 'synced' ? 'success' : 'info'
            );
        };

        // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        const refreshStatus = async () => {
            const dm = await waitForDataManager();
            updateSyncStatus(dm.syncStatus, `ìƒíƒœ: ${dm.syncStatus}, ë§ˆì§€ë§‰ ë™ê¸°í™”: ${dm.lastSyncTime || 'ì—†ìŒ'}`);
            log(`ë™ê¸°í™” ìƒíƒœ ìƒˆë¡œê³ ì¹¨: ${dm.syncStatus}`);
        };

        // ì§„ë‹¨ ì‹¤í–‰
        const runDiagnostics = async () => {
            log('ì‹œìŠ¤í…œ ì§„ë‹¨ ì‹œì‘...');
            try {
                const dm = await waitForDataManager();
                const diagnostics = await dm.runDiagnostics();
                
                log(`ì§„ë‹¨ ê²°ê³¼: ${diagnostics.overall} (${diagnostics.score})`);
                log(`localStorage: ${diagnostics.tests.localStorage ? 'âœ…' : 'âŒ'}`);
                log(`Supabase ì—°ê²°: ${diagnostics.tests.supabaseConnection ? 'âœ…' : 'âŒ'}`);
                log(`ë©”ëª¨ë¦¬ ìºì‹œ: ${diagnostics.tests.memoryCache ? 'âœ…' : 'âŒ'}`);
                
            } catch (error) {
                log(`ì§„ë‹¨ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        const generateTestParcels = async (count) => {
            log(`${count}ê°œ í…ŒìŠ¤íŠ¸ í•„ì§€ ìƒì„± ì¤‘...`);
            
            const testParcels = [];
            const colors = ['#FF0000', '#FFA500', '#FFFF00', '#90EE90', '#0000FF'];
            
            for (let i = 0; i < count; i++) {
                const parcel = {
                    id: `test_${Date.now()}_${i}`,
                    pnu: `test_pnu_${Date.now()}_${i}`,
                    parcelNumber: `í…ŒìŠ¤íŠ¸ì§€ë²ˆ ${Date.now()}-${i}`,
                    ownerName: `í…ŒìŠ¤íŠ¸ì†Œìœ ì${i + 1}`,
                    ownerAddress: `í…ŒìŠ¤íŠ¸ì£¼ì†Œ ${i + 1}ë²ˆì§€`,
                    ownerContact: `010-1234-${String(i).padStart(4, '0')}`,
                    memo: `í…ŒìŠ¤íŠ¸ ë©”ëª¨ ${i + 1}`,
                    color: colors[i % colors.length],
                    coordinates: [
                        { lat: 37.5665 + (Math.random() - 0.5) * 0.01, lng: 126.9780 + (Math.random() - 0.5) * 0.01 },
                        { lat: 37.5665 + (Math.random() - 0.5) * 0.01, lng: 126.9790 + (Math.random() - 0.5) * 0.01 },
                        { lat: 37.5675 + (Math.random() - 0.5) * 0.01, lng: 126.9790 + (Math.random() - 0.5) * 0.01 },
                        { lat: 37.5675 + (Math.random() - 0.5) * 0.01, lng: 126.9780 + (Math.random() - 0.5) * 0.01 }
                    ],
                    area: Math.round(Math.random() * 1000) + 100,
                    createdAt: new Date().toISOString()
                };
                testParcels.push(parcel);
            }
            
            try {
                const dm = await waitForDataManager();
                const result = await dm.save(testParcels);
                
                log(`${count}ê°œ í…ŒìŠ¤íŠ¸ í•„ì§€ ìƒì„± ì™„ë£Œ`);
                log(`ë¡œì»¬ ì €ì¥: ${result.local ? 'âœ…' : 'âŒ'}`);
                log(`í´ë¼ìš°ë“œ ë™ê¸°í™”: ${result.cloud ? 'âœ…' : 'ëŒ€ê¸°ì¤‘'}`);
                
                if (result.errors && result.errors.length > 0) {
                    log(`ì—ëŸ¬: ${result.errors.join(', ')}`, 'error');
                }
                
            } catch (error) {
                log(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        const clearTestData = async () => {
            if (!confirm('ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì¤‘...');
            try {
                const dm = await waitForDataManager();
                await dm.save([]);
                log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
            } catch (error) {
                log(`ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ìë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸
        const testAutoSync = async () => {
            log('ìë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            // ì‘ì€ ë³€ê²½ì‚¬í•­ ìƒì„±
            await generateTestParcels(2);
            log('2ì´ˆ í›„ ìë™ ë™ê¸°í™” ì‹¤í–‰ ì˜ˆì • (ë””ë°”ìš´ì‹±)');
            
            // 3ì´ˆ í›„ ê²°ê³¼ í™•ì¸
            setTimeout(async () => {
                const dm = await waitForDataManager();
                const stats = dm.getStats();
                log(`ìë™ ë™ê¸°í™” ê²°ê³¼ - ìƒíƒœ: ${stats.syncStatus}, í‰ê·  ì‹œê°„: ${stats.performance.avgSyncTime}ms`);
            }, 3000);
        };

        // ìˆ˜ë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸
        const testManualSync = async () => {
            log('ìˆ˜ë™ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            try {
                const dm = await waitForDataManager();
                const result = await dm.sync();
                log(`ìˆ˜ë™ ë™ê¸°í™” ì™„ë£Œ: ${result ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
            } catch (error) {
                log(`ìˆ˜ë™ ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ë°°ì¹˜ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ (í° ë°ì´í„°)
        const testBatchSync = async () => {
            log('ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            await generateTestParcels(25); // 25ê°œ í•„ì§€ë¡œ ë°°ì¹˜ í…ŒìŠ¤íŠ¸
        };

        // Google Sheets ë°±ì—… í…ŒìŠ¤íŠ¸
        const testGoogleBackup = async () => {
            log('Google Sheets ë°±ì—… í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            try {
                const dm = await waitForDataManager();
                
                if (dm.getGoogleBackupStatus().isAvailable) {
                    const result = await dm.manualGoogleBackup();
                    log(`Google Sheets ë°±ì—… ì™„ë£Œ: ${result.message}`);
                } else {
                    log('Google Sheets APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                log(`Google Sheets ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜
        const simulateNetworkError = () => {
            log('ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜...');
            // ì‹¤ì œë¡œëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ ì°¨ë‹¨í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¡œê·¸ë§Œ ì¶œë ¥
            log('ì‹¤ì œ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ëŠì–´ë³´ì„¸ìš”');
        };

        // ë°ì´í„° ì†ìƒ ì‹œë®¬ë ˆì´ì…˜
        const simulateDataCorruption = async () => {
            log('ë°ì´í„° ì†ìƒ ì‹œë®¬ë ˆì´ì…˜...');
            
            // ì˜ëª»ëœ ë°ì´í„° ìƒì„± ì‹œë„
            const corruptedParcel = {
                pnu: null, // í•„ìˆ˜ í•„ë“œ ëˆ„ë½
                coordinates: "invalid_coordinates", // ì˜ëª»ëœ í˜•ì‹
                area: "not_a_number" // ì˜ëª»ëœ íƒ€ì…
            };
            
            try {
                const dm = await waitForDataManager();
                await dm.save([corruptedParcel]);
            } catch (error) {
                log(`ì˜ˆìƒëœ ë°ì´í„° ì†ìƒ ì—ëŸ¬: ${error.message}`, 'error');
                log('ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤', 'info');
            }
        };

        // íšŒë¡œ ì°¨ë‹¨ê¸° í…ŒìŠ¤íŠ¸
        const testCircuitBreaker = async () => {
            log('íšŒë¡œ ì°¨ë‹¨ê¸° í…ŒìŠ¤íŠ¸...');
            const dm = await waitForDataManager();
            
            log(`í˜„ì¬ íšŒë¡œ ì°¨ë‹¨ê¸° ìƒíƒœ: ${dm.circuitBreaker.isOpen ? 'ì°¨ë‹¨ë¨' : 'ì •ìƒ'}`);
            log(`ì‹¤íŒ¨ íšŸìˆ˜: ${dm.circuitBreaker.failures}/${dm.circuitBreaker.threshold}`);
        };

        // ì—ëŸ¬ ë³µêµ¬ í…ŒìŠ¤íŠ¸
        const recoverFromError = async () => {
            log('ì—ëŸ¬ ë³µêµ¬ í…ŒìŠ¤íŠ¸...');
            try {
                const dm = await waitForDataManager();
                const result = await dm.recoverFromErrors();
                log(`ì—ëŸ¬ ë³µêµ¬ ${result ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
            } catch (error) {
                log(`ì—ëŸ¬ ë³µêµ¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // í†µê³„ ì—…ë°ì´íŠ¸
        const updateStats = async () => {
            try {
                const dm = await waitForDataManager();
                const stats = dm.getStats();
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h4>ğŸ“Š ê¸°ë³¸ ì •ë³´</h4>
                        <p>ì´ í•„ì§€: ${stats.totalParcels}ê°œ</p>
                        <p>ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${(stats.memoryUsage / 1024).toFixed(1)}KB</p>
                        <p>ë°ì´í„° ë²„ì „: ${stats.dataVersion || 'ì—†ìŒ'}</p>
                    </div>
                    <div class="stat-card">
                        <h4>âš¡ ì„±ëŠ¥</h4>
                        <p>í‰ê·  ë™ê¸°í™” ì‹œê°„: ${stats.performance.avgSyncTime}ms</p>
                        <p>ì´ ë™ê¸°í™” íšŸìˆ˜: ${stats.performance.totalSyncs}íšŒ</p>
                        <p>ìºì‹œ ìƒíƒœ: ${stats.performance.cacheHitRate}</p>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸš¨ ì—ëŸ¬</h4>
                        <p>ì´ ì—ëŸ¬: ${stats.errors.total}ê°œ</p>
                        <p>ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${stats.errors.breakdown.network || 0}ê°œ</p>
                        <p>ì¬ì‹œë„ íšŸìˆ˜: ${stats.errors.breakdown.retry || 0}íšŒ</p>
                        <p>íšŒë¡œ ì°¨ë‹¨ê¸°: ${stats.errors.circuitBreakerStatus}</p>
                    </div>
                    <div class="stat-card">
                        <h4>ğŸ”§ ìµœì í™”</h4>
                        <p>ë°°ì¹˜ í¬ê¸° ìºì‹œ: ${stats.optimization.dynamicBatchSizes}ê°œ</p>
                        <p>ìë™ ë™ê¸°í™”: ${stats.optimization.autoSyncEnabled ? 'í™œì„±' : 'ë¹„í™œì„±'}</p>
                        <p>ë§ˆì§€ë§‰ Google ë°±ì—…: ${stats.optimization.lastGoogleBackup}</p>
                    </div>
                `;
                
                log('í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
            } catch (error) {
                log(`í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ë¡œê·¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        const clearLog = () => {
            document.getElementById('logOutput').textContent = '';
        };

        const exportLog = () => {
            const logContent = document.getElementById('logOutput').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sync-test-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // DataManager ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const setupEventListeners = async () => {
            const dm = await waitForDataManager();
            
            // ë™ê¸°í™” ìƒíƒœ ë³€ê²½ ê°ì§€
            dm.onSyncStatusChange((status, prevStatus) => {
                const statusMessages = {
                    'offline': 'ì˜¤í”„ë¼ì¸ - Supabase ì—°ê²° ì—†ìŒ',
                    'syncing': 'ë™ê¸°í™” ì¤‘...',
                    'synced': 'ë™ê¸°í™” ì™„ë£Œ',
                    'error': 'ë™ê¸°í™” ì—ëŸ¬ ë°œìƒ'
                };
                
                updateSyncStatus(status, statusMessages[status] || status);
                log(`ë™ê¸°í™” ìƒíƒœ ë³€ê²½: ${prevStatus} â†’ ${status}`);
            });

            // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
            await refreshStatus();
            await updateStats();
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            log('ì‹¤ì‹œê°„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            setupEventListeners();
            
            // ì£¼ê¸°ì  í†µê³„ ì—…ë°ì´íŠ¸ (10ì´ˆë§ˆë‹¤)
            setInterval(updateStats, 10000);
        });
    </script>
</body>
</html>