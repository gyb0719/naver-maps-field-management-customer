<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì œ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2196f3;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .phase {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #007bff;
        }

        .phase.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .phase.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .phase.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .phase h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.5s ease;
            border-radius: 10px;
            width: 0%;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .log-info { background: #e3f2fd; color: #1976d2; }
        .log-success { background: #e8f5e8; color: #388e3c; }
        .log-warning { background: #fff3e0; color: #f57c00; }
        .log-error { background: #ffebee; color: #d32f2f; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .details {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ì‹¤ì œ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
            <p>ì§„ì§œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì™„ì „í•œ í…ŒìŠ¤íŠ¸</p>
        </div>

        <div class="content">
            <!-- í˜„ì¬ ë°ì´í„° í˜„í™© -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="localParcels">-</div>
                    <div class="stat-label">ë¡œì»¬ í•„ì§€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="localMemos">-</div>
                    <div class="stat-label">ë¡œì»¬ ë©”ëª¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="supabaseParcels">-</div>
                    <div class="stat-label">Supabase í•„ì§€</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="supabaseMemos">-</div>
                    <div class="stat-label">Supabase ë©”ëª¨</div>
                </div>
            </div>

            <!-- ë§ˆì´ê·¸ë ˆì´ì…˜ ë‹¨ê³„ -->
            <div class="phase" id="phase1">
                <h3>ğŸ“‹ 1. ë°ì´í„° ê²€ì¦</h3>
                <p>ì‹¤ì œ í•„ì§€ì™€ ë©”ëª¨ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress1"></div>
                </div>
                <div id="validationDetails" class="details hidden"></div>
            </div>

            <div class="phase" id="phase2">
                <h3>ğŸ’¾ 2. ë°±ì—… ìƒì„±</h3>
                <p>ì‹¤ì œ ë°±ì—…ì„ ìƒì„±í•˜ê³  ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress2"></div>
                </div>
            </div>

            <div class="phase" id="phase3">
                <h3>ğŸ”„ 3. ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜</h3>
                <p>Supabase RPC í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì œë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress3"></div>
                </div>
                <div id="migrationDetails" class="details hidden"></div>
            </div>

            <div class="phase" id="phase4">
                <h3>âœ… 4. ì €ì¥ ê²€ì¦</h3>
                <p>Supabase í…Œì´ë¸”ì— ì‹¤ì œë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress4"></div>
                </div>
            </div>

            <!-- ë²„íŠ¼ë“¤ -->
            <div class="buttons">
                <button class="btn btn-primary" id="validateBtn" onclick="startValidation()">
                    <span id="validateText">ê²€ì¦ ì‹œì‘</span>
                </button>
                <button class="btn btn-success" id="migrateBtn" onclick="startRealMigration()" disabled>
                    <span id="migrateText">ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜</span>
                </button>
                <button class="btn btn-danger" id="rollbackBtn" onclick="performRollback()" disabled>
                    ë¡¤ë°± ì‹¤í–‰
                </button>
                <button class="btn btn-warning" id="googleBackupBtn" onclick="startGoogleBackup()">
                    ğŸ“Š Google Sheets ë°±ì—…
                </button>
            </div>

            <!-- ë¡œê·¸ -->
            <div class="log" id="migrationLog">
                <div class="log-entry log-info">ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ âœ…</div>
            </div>
        </div>
    </div>

    <!-- Google API ë¡œë“œ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="/js/auth.js"></script>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://iccixxihdsvbgbkuwdqj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljY2l4eGloZHN2Ymdia3V3ZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTYyNjksImV4cCI6MjA3MjY3MjI2OX0.sEiGF7sImn2aY4Bl1463DVVZOmZuczTXfkgTS2-A074';

        let migrationInProgress = false;
        let currentMigrationId = null;
        let googleBackupInProgress = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataStats();
            addLog('ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ', 'success');
        });

        // í˜„ì¬ ë°ì´í„° í†µê³„ ë¡œë“œ
        async function loadDataStats() {
            try {
                const localData = getLocalStorageData();
                document.getElementById('localParcels').textContent = localData.parcels.length.toLocaleString();
                document.getElementById('localMemos').textContent = localData.memos.length.toLocaleString();

                await updateSupabaseStats();
                addLog(`ë¡œì»¬ ë°ì´í„°: í•„ì§€ ${localData.parcels.length}ê°œ, ë©”ëª¨ ${localData.memos.length}ê°œ`, 'info');
            } catch (error) {
                addLog(`í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Supabase í†µê³„ ì—…ë°ì´íŠ¸
        async function updateSupabaseStats() {
            try {
                const parcelsResponse = await fetch(`${SUPABASE_URL}/rest/v1/parcels?select=id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });

                const memosResponse = await fetch(`${SUPABASE_URL}/rest/v1/memos?select=id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });

                const parcelCount = parcelsResponse.headers.get('content-range')?.split('/')[1] || 0;
                const memoCount = memosResponse.headers.get('content-range')?.split('/')[1] || 0;

                document.getElementById('supabaseParcels').textContent = parseInt(parcelCount).toLocaleString();
                document.getElementById('supabaseMemos').textContent = parseInt(memoCount).toLocaleString();

            } catch (error) {
                document.getElementById('supabaseParcels').textContent = 'N/A';
                document.getElementById('supabaseMemos').textContent = 'N/A';
                addLog('Supabase í†µê³„ ì¡°íšŒ ì‹¤íŒ¨', 'warning');
            }
        }

        // localStorage ë°ì´í„° ì¶”ì¶œ
        function getLocalStorageData() {
            try {
                const saved = localStorage.getItem('parcel-manager-data');
                return saved ? JSON.parse(saved) : { parcels: [], memos: [] };
            } catch (error) {
                return { parcels: [], memos: [] };
            }
        }

        // ë°ì´í„° ê²€ì¦
        async function startValidation() {
            const btn = document.getElementById('validateBtn');
            const text = document.getElementById('validateText');
            
            btn.disabled = true;
            text.innerHTML = '<span class="loading"></span>ê²€ì¦ ì¤‘...';
            
            setPhaseActive('phase1');
            addLog('ì‹¤ì œ ë°ì´í„° ê²€ì¦ ì‹œì‘...', 'info');

            try {
                const localData = getLocalStorageData();
                
                if (localData.parcels.length === 0) {
                    throw new Error('ë§ˆì´ê·¸ë ˆì´ì…˜í•  í•„ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                }

                // ì‹¤ì œ ê²€ì¦ ë¡œì§
                let validCount = 0;
                let errorCount = 0;
                const errors = [];

                for (let i = 0; i < localData.parcels.length; i++) {
                    const parcel = localData.parcels[i];
                    
                    try {
                        validateParcel(parcel);
                        validCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push(`í•„ì§€ ${i + 1}: ${error.message}`);
                    }

                    const progress = ((i + 1) / localData.parcels.length) * 100;
                    updateProgress('progress1', progress);
                    
                    if (i % 50 === 0) {
                        await delay(10);
                    }
                }

                updateProgress('progress1', 100);
                setPhaseCompleted('phase1');

                // ê²€ì¦ ê²°ê³¼ í‘œì‹œ
                const details = document.getElementById('validationDetails');
                details.innerHTML = `
                    <strong>ê²€ì¦ ê²°ê³¼:</strong><br>
                    âœ… ìœ íš¨: ${validCount}ê°œ<br>
                    âŒ ì˜¤ë¥˜: ${errorCount}ê°œ<br>
                    ${errors.length > 0 ? '<br><strong>ì˜¤ë¥˜ ìƒ˜í”Œ:</strong><br>' + errors.slice(0, 5).join('<br>') : ''}
                `;
                details.classList.remove('hidden');

                addLog(`ê²€ì¦ ì™„ë£Œ: ìœ íš¨ ${validCount}ê°œ, ì˜¤ë¥˜ ${errorCount}ê°œ`, validCount > errorCount ? 'success' : 'warning');
                
                if (validCount > localData.parcels.length * 0.8) {
                    document.getElementById('migrateBtn').disabled = false;
                } else {
                    throw new Error('ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: ë„ˆë¬´ ë§ì€ ì˜¤ë¥˜');
                }

            } catch (error) {
                setPhaseError('phase1');
                addLog(`ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                text.textContent = 'ì¬ê²€ì¦';
            }
        }

        // í•„ì§€ ê²€ì¦
        function validateParcel(parcel) {
            if (!parcel.pnu || parcel.pnu.trim() === '') {
                throw new Error('PNU ì—†ìŒ');
            }
            if (!parcel.coordinates || !Array.isArray(parcel.coordinates) || parcel.coordinates.length < 3) {
                throw new Error('ì¢Œí‘œ ë°ì´í„° ë¶€ì¡±');
            }
            
            for (const coord of parcel.coordinates) {
                if (!coord.lat || !coord.lng) {
                    throw new Error('ì¢Œí‘œê°’ ì—†ìŒ');
                }
                if (coord.lat < 33 || coord.lat > 39 || coord.lng < 124 || coord.lng > 132) {
                    throw new Error('í•œêµ­ ì˜í†  ë°– ì¢Œí‘œ');
                }
            }
            
            return true;
        }

        // ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
        async function startRealMigration() {
            if (migrationInProgress) return;
            
            if (!confirm('ì‹¤ì œ Supabaseì— ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            migrationInProgress = true;
            currentMigrationId = `migration_${Date.now()}`;
            
            const btn = document.getElementById('migrateBtn');
            const text = document.getElementById('migrateText');
            
            btn.disabled = true;
            text.innerHTML = '<span class="loading"></span>ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...';
            
            document.getElementById('rollbackBtn').disabled = false;

            try {
                // 2ë‹¨ê³„: ë°±ì—… ìƒì„±
                await createRealBackup();

                // 3ë‹¨ê³„: ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜
                await executeRealMigration();

                // 4ë‹¨ê³„: ì €ì¥ ê²€ì¦
                await verifyStorage();

                addLog('ğŸ‰ ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ì™„ë£Œ!', 'success');
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    loadDataStats();
                }, 2000);

            } catch (error) {
                addLog(`ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
                addLog('ë¡¤ë°±ì„ ì‹¤í–‰í•˜ì„¸ìš”', 'warning');
            } finally {
                migrationInProgress = false;
                btn.disabled = false;
                text.textContent = 'ì™„ë£Œ';
            }
        }

        // ì‹¤ì œ ë°±ì—… ìƒì„±
        async function createRealBackup() {
            setPhaseActive('phase2');
            addLog('ì‹¤ì œ ë°±ì—… ìƒì„± ì¤‘...', 'info');
            
            const localData = getLocalStorageData();
            const backup = {
                timestamp: new Date().toISOString(),
                migrationId: currentMigrationId,
                version: '2.0',
                type: 'real_migration_backup',
                data: localData
            };
            
            // ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([JSON.stringify(backup, null, 2)], { 
                type: 'application/json' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `real-migration-backup-${currentMigrationId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateProgress('progress2', 100);
            setPhaseCompleted('phase2');
            addLog('ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
        }

        // ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
        async function executeRealMigration() {
            setPhaseActive('phase3');
            addLog('ì‹¤ì œ Supabase RPC í•¨ìˆ˜ í˜¸ì¶œ ì‹œì‘...', 'info');
            
            const localData = getLocalStorageData();
            const BATCH_SIZE = 5; // ì•ˆì „í•œ ë°°ì¹˜ í¬ê¸°
            
            let processedParcels = 0;
            let processedMemos = 0;
            let successCount = 0;
            let errorCount = 0;

            // í•„ì§€ ë§ˆì´ê·¸ë ˆì´ì…˜
            const parcelBatches = createBatches(localData.parcels, BATCH_SIZE);
            
            for (let i = 0; i < parcelBatches.length; i++) {
                const batch = parcelBatches[i];
                
                try {
                    const batchData = batch.map(parcel => ({
                        pnu: parcel.pnu,
                        address: parcel.address || '',
                        jibun: parcel.jibun || '',
                        area: parcel.area || 0,
                        owner_name: parcel.ownerName || '',
                        geometry: coordinatesToWKT(parcel.coordinates),
                        centerLng: parcel.lng || 0,
                        centerLat: parcel.lat || 0,
                        color: parcel.color || 'red',
                        rawVworldData: parcel.rawData || {}
                    }));

                    // ì‹¤ì œ Supabase RPC í˜¸ì¶œ
                    const result = await callSupabaseRPC('secure_batch_insert', {
                        batch_type: 'parcels',
                        batch_data: batchData,
                        input_migration_id: currentMigrationId
                    });

                    if (result && result.length > 0) {
                        successCount += result[0].count || 0;
                        if (result[0].errors && result[0].errors.length > 0) {
                            errorCount += result[0].errors.length;
                            addLog(`ë°°ì¹˜ ${i + 1} ì¼ë¶€ ì˜¤ë¥˜: ${result[0].errors.length}ê°œ`, 'warning');
                        }
                    }

                    processedParcels += batch.length;
                    const progress = (processedParcels / localData.parcels.length) * 70; // 70%ê¹Œì§€
                    updateProgress('progress3', progress);
                    
                    addLog(`í•„ì§€ ë°°ì¹˜ ${i + 1}/${parcelBatches.length} ì²˜ë¦¬ ì™„ë£Œ (${batch.length}ê°œ)`, 'info');
                    
                    // ì„œë²„ ë¶€í•˜ ë°©ì§€
                    await delay(200);
                    
                } catch (error) {
                    errorCount += batch.length;
                    addLog(`í•„ì§€ ë°°ì¹˜ ${i + 1} ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }

            // ë©”ëª¨ ë§ˆì´ê·¸ë ˆì´ì…˜ (í•„ì§€ ì €ì¥ ì™„ë£Œ í›„)
            if (localData.memos.length > 0) {
                addLog('ë©”ëª¨ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
                
                // ì €ì¥ëœ í•„ì§€ì˜ PNU -> ID ë§¤í•‘ ìƒì„±
                const parcelMapping = await createParcelMapping();
                
                const memosWithIds = localData.memos.map(memo => ({
                    parcel_id: parcelMapping[memo.pnu],
                    content: memo.content || ''
                })).filter(memo => memo.parcel_id);

                const memoBatches = createBatches(memosWithIds, BATCH_SIZE);
                
                for (let i = 0; i < memoBatches.length; i++) {
                    const batch = memoBatches[i];
                    
                    try {
                        const result = await callSupabaseRPC('secure_batch_insert', {
                            batch_type: 'memos',
                            batch_data: batch,
                            input_migration_id: currentMigrationId
                        });

                        if (result && result.length > 0) {
                            processedMemos += result[0].count || 0;
                        }
                        
                        const progress = 70 + ((i + 1) / memoBatches.length) * 30; // 70%-100%
                        updateProgress('progress3', progress);
                        
                        addLog(`ë©”ëª¨ ë°°ì¹˜ ${i + 1}/${memoBatches.length} ì²˜ë¦¬ ì™„ë£Œ`, 'info');
                        await delay(200);
                        
                    } catch (error) {
                        addLog(`ë©”ëª¨ ë°°ì¹˜ ${i + 1} ì‹¤íŒ¨: ${error.message}`, 'error');
                    }
                }
            }

            updateProgress('progress3', 100);
            setPhaseCompleted('phase3');

            // ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ í‘œì‹œ
            const details = document.getElementById('migrationDetails');
            details.innerHTML = `
                <strong>ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼:</strong><br>
                âœ… ì„±ê³µí•œ í•„ì§€: ${successCount}ê°œ<br>
                âŒ ì‹¤íŒ¨í•œ í•„ì§€: ${errorCount}ê°œ<br>
                âœ… ì²˜ë¦¬ëœ ë©”ëª¨: ${processedMemos}ê°œ<br>
                ğŸ”‘ ë§ˆì´ê·¸ë ˆì´ì…˜ ID: ${currentMigrationId}
            `;
            details.classList.remove('hidden');

            addLog(`ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: í•„ì§€ ${successCount}ê°œ, ë©”ëª¨ ${processedMemos}ê°œ`, 'success');
        }

        // Supabase RPC í•¨ìˆ˜ í˜¸ì¶œ
        async function callSupabaseRPC(functionName, params) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${functionName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify(params)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`RPC í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${error}`);
            }

            return await response.json();
        }

        // í•„ì§€ ë§¤í•‘ ìƒì„±
        async function createParcelMapping() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/parcels?select=id,pnu&migration_id=eq.${currentMigrationId}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('í•„ì§€ ë§¤í•‘ ì¡°íšŒ ì‹¤íŒ¨');
                
                const parcels = await response.json();
                const mapping = {};
                parcels.forEach(parcel => {
                    mapping[parcel.pnu] = parcel.id;
                });
                
                return mapping;
            } catch (error) {
                addLog(`í•„ì§€ ë§¤í•‘ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                return {};
            }
        }

        // ì €ì¥ ê²€ì¦
        async function verifyStorage() {
            setPhaseActive('phase4');
            addLog('Supabase ì €ì¥ ê²€ì¦ ì¤‘...', 'info');
            
            try {
                // ì‹¤ì œ ì €ì¥ëœ ë°ì´í„° í™•ì¸
                const result = await callSupabaseRPC('get_migration_status', {
                    input_migration_id: currentMigrationId
                });

                if (result && result.length > 0) {
                    const status = result[0];
                    addLog(`ê²€ì¦ ì™„ë£Œ - í•„ì§€: ${status.parcel_count}ê°œ, ë©”ëª¨: ${status.memo_count}ê°œ`, 'success');
                    
                    updateProgress('progress4', 100);
                    setPhaseCompleted('phase4');
                } else {
                    throw new Error('ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                setPhaseError('phase4');
                addLog(`ì €ì¥ ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
                throw error;
            }
        }

        // ë¡¤ë°± ì‹¤í–‰
        async function performRollback() {
            if (!currentMigrationId) {
                addLog('ë¡¤ë°±í•  ë§ˆì´ê·¸ë ˆì´ì…˜ IDê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }

            if (!confirm(`ë§ˆì´ê·¸ë ˆì´ì…˜ ID: ${currentMigrationId}\nì •ë§ë¡œ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const btn = document.getElementById('rollbackBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ë¡¤ë°± ì¤‘...';

            try {
                const result = await callSupabaseRPC('emergency_rollback', {
                    input_migration_id: currentMigrationId
                });

                if (result && result.length > 0) {
                    const rollback = result[0];
                    addLog(`ë¡¤ë°± ì™„ë£Œ: í•„ì§€ ${rollback.deleted_parcels}ê°œ, ë©”ëª¨ ${rollback.deleted_memos}ê°œ ì‚­ì œ`, 'success');
                    
                    setTimeout(() => {
                        loadDataStats();
                    }, 1000);
                }

            } catch (error) {
                addLog(`ë¡¤ë°± ì‹¤íŒ¨: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë¡¤ë°± ì‹¤í–‰';
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function createBatches(array, size) {
            const batches = [];
            for (let i = 0; i < array.length; i += size) {
                batches.push(array.slice(i, i + size));
            }
            return batches;
        }

        function coordinatesToWKT(coordinates) {
            if (!coordinates || !Array.isArray(coordinates) || coordinates.length < 3) {
                return null;
            }

            const coords = [...coordinates];
            const first = coords[0];
            const last = coords[coords.length - 1];
            
            if (first.lng !== last.lng || first.lat !== last.lat) {
                coords.push(first);
            }

            const wktCoords = coords
                .map(coord => `${coord.lng} ${coord.lat}`)
                .join(', ');
            
            return `POLYGON((${wktCoords}))`;
        }

        function setPhaseActive(phaseId) {
            const phase = document.getElementById(phaseId);
            phase.classList.add('active');
        }

        function setPhaseCompleted(phaseId) {
            const phase = document.getElementById(phaseId);
            phase.classList.remove('active');
            phase.classList.add('completed');
        }

        function setPhaseError(phaseId) {
            const phase = document.getElementById(phaseId);
            phase.classList.remove('active');
            phase.classList.add('error');
        }

        function updateProgress(progressId, percent) {
            const progress = document.getElementById(progressId);
            progress.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Google Sheets ë°±ì—… ì‹œì‘
        async function startGoogleBackup() {
            if (googleBackupInProgress) return;
            
            const localData = getLocalStorageData();
            if (!localData || !localData.parcels || localData.parcels.length === 0) {
                alert('ë°±ì—…í•  ë¡œì»¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\ní…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.');
                return;
            }

            if (!confirm(`Google Sheetsì— ë°ì´í„°ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤.\n\ní•„ì§€: ${localData.parcels.length}ê°œ\në©”ëª¨: ${localData.memos?.length || 0}ê°œ\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            googleBackupInProgress = true;
            const btn = document.getElementById('googleBackupBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Google ë¡œê·¸ì¸ ì¤‘...';

            try {
                // Google API ì´ˆê¸°í™” í™•ì¸
                await GoogleAuth.initializeAuth();
                
                // Google ì¸ì¦ í™•ì¸
                if (!GoogleAuth.isAuthenticated()) {
                    addLog('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤...', 'info');
                    
                    // í† í° ìš”ì²­
                    const tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GoogleAuth.CLIENT_ID,
                        scope: GoogleAuth.SCOPES,
                        callback: async (tokenResponse) => {
                            GoogleAuth.saveTokens(tokenResponse);
                            addLog('âœ… Google ì¸ì¦ ì™„ë£Œ', 'success');
                            await performBackup();
                        },
                        error_callback: (error) => {
                            throw new Error('Google ì¸ì¦ ì‹¤íŒ¨: ' + error.message);
                        }
                    });
                    
                    tokenClient.requestAccessToken();
                    return;
                }

                await performBackup();

            } catch (error) {
                addLog(`âŒ Google ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
                
                if (error.message.includes('401') || error.message.includes('403')) {
                    addLog('Google ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
                }
                
                googleBackupInProgress = false;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }

            async function performBackup() {
                try {
                    btn.innerHTML = '<span class="loading"></span>í•„ì§€ ë°ì´í„° ë°±ì—… ì¤‘...';
                    addLog('ğŸ“Š í•„ì§€ ë°ì´í„° ë°±ì—… ì‹œì‘...', 'info');
                    
                    // ë°ì´í„° êµ¬ì¡° ë””ë²„ê¹…
                    console.log('=== ë°±ì—… ë°ì´í„° ë””ë²„ê¹… ===');
                    console.log('ì „ì²´ ë°ì´í„°:', localData);
                    console.log('í•„ì§€ ìˆ˜:', localData.parcels.length);
                    console.log('ì²« ë²ˆì§¸ í•„ì§€:', localData.parcels[0]);
                    if (localData.memos) {
                        console.log('ë©”ëª¨ ìˆ˜:', localData.memos.length);
                        console.log('ì²« ë²ˆì§¸ ë©”ëª¨:', localData.memos[0]);
                    }

                    // í•„ì§€ ë°ì´í„° ë°±ì—…
                    const parcelResult = await GoogleAuth.backupParcelsToSheets(
                        localData.parcels,
                        (progress, message) => {
                            btn.innerHTML = `<span class="loading"></span>í•„ì§€ ë°±ì—… ì¤‘... ${progress}%`;
                            if (progress % 10 === 0) { // 10%ë§ˆë‹¤ ë¡œê·¸
                                addLog(`ğŸ“Š í•„ì§€ ë°±ì—…: ${message}`, 'info');
                            }
                        }
                    );

                    addLog(`âœ… í•„ì§€ ë°±ì—… ì™„ë£Œ: ${parcelResult.processedCount}ê°œ`, 'success');
                    
                    // ë©”ëª¨ ë°ì´í„° ë°±ì—… (ìˆëŠ” ê²½ìš°)
                    if (localData.memos && localData.memos.length > 0) {
                        btn.innerHTML = '<span class="loading"></span>ë©”ëª¨ ë°ì´í„° ë°±ì—… ì¤‘...';
                        addLog('ğŸ“ ë©”ëª¨ ë°ì´í„° ë°±ì—… ì‹œì‘...', 'info');
                        
                        const memoResult = await GoogleAuth.backupMemosToSheets(
                            localData.memos,
                            (progress, message) => {
                                btn.innerHTML = `<span class="loading"></span>ë©”ëª¨ ë°±ì—… ì¤‘... ${progress}%`;
                                if (progress % 10 === 0) {
                                    addLog(`ğŸ“ ë©”ëª¨ ë°±ì—…: ${message}`, 'info');
                                }
                            }
                        );

                        addLog(`âœ… ë©”ëª¨ ë°±ì—… ì™„ë£Œ: ${memoResult.processedCount}ê°œ`, 'success');
                    }

                    addLog('ğŸ‰ Google Sheets ë°±ì—… ì™„ë£Œ!', 'success');
                    
                    // ë°±ì—… ë§í¬ ì œê³µ
                    const parcelSheetUrl = `https://docs.google.com/spreadsheets/d/${parcelResult.spreadsheetId}`;
                    addLog(`ğŸ“Š ë°±ì—… ì‹œíŠ¸ ë§í¬: ${parcelSheetUrl}`, 'info');
                    
                    if (confirm('ë°±ì—…ëœ Google Sheetsë¥¼ ìƒˆ íƒ­ì—ì„œ ì—¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.open(parcelSheetUrl, '_blank');
                    }

                } catch (error) {
                    throw error;
                } finally {
                    googleBackupInProgress = false;
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ë°©ì§€
        window.addEventListener('beforeunload', (e) => {
            if (migrationInProgress || googleBackupInProgress) {
                e.preventDefault();
                e.returnValue = 'ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';
            }
        });
    </script>
</body>
</html>