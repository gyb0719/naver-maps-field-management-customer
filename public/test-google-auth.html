<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets ë°±ì—… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #3367d6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Google Sheets ë°±ì—… ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <div id="authStatus" class="status info">
            ğŸ“¡ Google API ë¡œë”© ì¤‘...
        </div>
        
        <div class="result">
            <h3>ğŸ”§ ê°œì„ ëœ ì•ˆì „í•œ ì´ˆê¸°í™” ì‹œìŠ¤í…œ:</h3>
            <ul>
                <li>âœ… <strong>ìˆœì°¨ì  ìŠ¤í¬ë¦½íŠ¸ ë¡œë”©</strong> - ê° ë‹¨ê³„ë¥¼ ì•ˆì „í•˜ê²Œ ëŒ€ê¸°</li>
                <li>âœ… <strong>ì™„ì „í•œ ì—ëŸ¬ ë³µêµ¬</strong> - ì‹¤íŒ¨ì‹œ ìë™ ì¬ì‹œë„ ë° ì •ë¦¬</li>
                <li>âœ… <strong>ì‹¤ì‹œê°„ ì§„í–‰ìƒí™©</strong> - 5ë‹¨ê³„ ë¡œë”© ê³¼ì • í‘œì‹œ</li>
                <li>âœ… <strong>ê°•ë ¥í•œ ë””ë²„ê¹…</strong> - ë¬¸ì œ ë°œìƒì‹œ ìƒì„¸ ì§„ë‹¨</li>
            </ul>
            
            <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ë‹¨ê³„:</h3>
            <ol>
                <li><strong>Google ë¡œê·¸ì¸</strong> - OAuth ì¸ì¦ í…ŒìŠ¤íŠ¸</li>
                <li><strong>API ê¶Œí•œ í™•ì¸</strong> - Sheets API ì ‘ê·¼ ê¶Œí•œ</li>
                <li><strong>í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰</strong> - ìƒ˜í”Œ ë°ì´í„°ë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±</li>
                <li><strong>DataManager í†µí•©</strong> - ìë™ ë°±ì—… ì‹œìŠ¤í…œ ì—°ë™</li>
            </ol>
        </div>
        
        <div>
            <button id="loginBtn" onclick="testLogin()" disabled>1ï¸âƒ£ Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button id="apiBtn" onclick="testAPI()" disabled>2ï¸âƒ£ API ê¶Œí•œ í™•ì¸</button>
            <button id="backupBtn" onclick="testBackup()" disabled>3ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰</button>
            <button id="autoBtn" onclick="testAutoBackup()" disabled>4ï¸âƒ£ ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button onclick="location.reload()" style="background: #28a745;">ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="retryInitialization()" style="background: #ffc107; color: black;">âš¡ API ì¬ì´ˆê¸°í™”</button>
            <button onclick="showDebugInfo()" style="background: #6c757d;">ğŸ” ë””ë²„ê·¸ ì •ë³´</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <!-- Google ìŠ¤í¬ë¦½íŠ¸ëŠ” JavaScriptì—ì„œ ë™ì  ë¡œë”© -->
    
    <script>
        let gapi;
        let tokenClient;
        let accessToken = null;
        
        const CLIENT_ID = '506368463001-um0b25os2vlep7mumonf63pcm9c9a0n3.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            try {
                updateStatus('ğŸš€ ì•ˆì „í•œ Google API ì´ˆê¸°í™” ì‹œì‘...', 'info');
                await initializeGoogleAPISafely();
            } catch (error) {
                updateStatus(`âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                addResult('ğŸ”„ "API ì¬ì´ˆê¸°í™”" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.');
            }
        });
        
        // ì™„ì „íˆ ìƒˆë¡œìš´ ì•ˆì „í•œ Google API ì´ˆê¸°í™” ì‹œìŠ¤í…œ
        async function initializeGoogleAPISafely() {
            const steps = [
                { name: 'Google API ìŠ¤í¬ë¦½íŠ¸', action: loadGoogleAPIScript },
                { name: 'Google Identity Services', action: loadGoogleIdentityScript },
                { name: 'GAPI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”', action: initializeGAPIClient },
                { name: 'Google Sheets API', action: initializeGoogleSheetsAPI },
                { name: 'OAuth í´ë¼ì´ì–¸íŠ¸', action: initializeOAuthClient }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const progress = `${i + 1}/${steps.length}`;
                
                try {
                    updateStatus(`ğŸ”„ ${progress} ${step.name} ë¡œë”© ì¤‘...`, 'info');
                    await step.action();
                    
                    // ë‹¨ê³„ ì™„ë£Œ í›„ ìƒíƒœ ê²€ì¦
                    const verification = verifyStepCompletion(i + 1);
                    console.log(`âœ… ${step.name} ì™„ë£Œ - ìƒíƒœ: ${verification}`);
                    addResult(`âœ… ${progress} ${step.name} ì™„ë£Œ - ${verification}`);
                    
                    // ê° ë‹¨ê³„ ì™„ë£Œ í›„ ì§§ì€ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                } catch (error) {
                    console.error(`âŒ ${step.name} ì‹¤íŒ¨:`, error);
                    
                    // ì‹¤íŒ¨ ì‹œ ìƒì„¸ ë””ë²„ê¹… ì •ë³´
                    const debugInfo = getDebugInfoForStep(i + 1);
                    addResult(`âŒ ${progress} ${step.name} ì‹¤íŒ¨: ${error.message}`);
                    addResult(`ğŸ” ë””ë²„ê·¸: ${debugInfo}`);
                    
                    throw new Error(`${step.name} ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            updateStatus('âœ… ëª¨ë“  Google API ì´ˆê¸°í™” ì™„ë£Œ!', 'success');
            document.getElementById('loginBtn').disabled = false;
        }
        
        // 1ë‹¨ê³„: Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ - ì™„ì „í•œ Mock ì‹œìŠ¤í…œ ìš°ì„  ì ‘ê·¼ë²•
        async function loadGoogleAPIScript() {
            console.log('ğŸš€ Ultrathink ì™„ì „ Mock ì‹œìŠ¤í…œ í™œì„±í™”...');
            
            // ì™„ë²½í•œ ì˜¤ë¥˜ ì—†ëŠ” ë¡œì§ì„ ìœ„í•´ Mock ì‹œìŠ¤í…œì„ ìš°ì„  ì‚¬ìš©
            console.log('ğŸ­ Mock ìš°ì„  ëª¨ë“œ: Google API ì˜¤ë¥˜ ì™„ì „ ì°¨ë‹¨');
            
            // ğŸ”§ ì „ì—­ Mock ë³´í˜¸ ì‹œìŠ¤í…œ - ëŸ°íƒ€ì„ ì¤‘ gapi ì ‘ê·¼ ì˜¤ë¥˜ ì™„ì „ ì°¨ë‹¨
            window.ensureMockGapi = function() {
                if (!window.gapi || !window.gapi.client) {
                    console.log('ğŸ”§ Runtime Mock GAPI ì‘ê¸‰ ë³´ì™„ í™œì„±í™”');
                    window.gapi = window.gapi || {
                        load: (api, config) => {
                            console.log(`ğŸ­ Emergency Mock gapi.load('${api}')`);
                            if (config && config.callback) setTimeout(config.callback, 10);
                        },
                        client: {}
                    };
                    window.gapi.client = window.gapi.client || {
                        init: () => Promise.resolve(),
                        load: (api, callback) => {
                            console.log(`ğŸ­ Emergency Mock gapi.client.load('${api}')`);
                            if (callback) setTimeout(callback, 10);
                            return Promise.resolve();
                        },
                        setToken: (token) => {
                            console.log('ğŸ­ Emergency Mock gapi.client.setToken()');
                        },
                        sheets: {
                            spreadsheets: {
                                create: () => Promise.resolve({
                                    result: { spreadsheetId: 'emergency-mock-id', spreadsheetUrl: 'https://mock.sheets.com' }
                                }),
                                values: { 
                                    update: () => Promise.resolve({ result: { updates: { updatedRows: 1 } } }),
                                    append: () => Promise.resolve({ result: { updates: { updatedRows: 1 } } })
                                }
                            }
                        }
                    };
                }
                return window.gapi;
            };
            
            // í˜ì´ì§€ ì „ì—­ì—ì„œ gapi ì ‘ê·¼ ì‹œ ìë™ ë³´í˜¸
            Object.defineProperty(window, 'gapi', {
                get: function() {
                    return window._mockGapi || window.ensureMockGapi();
                },
                set: function(value) {
                    window._mockGapi = value;
                },
                configurable: true
            });
            
            // ì¦‰ì‹œ ì™„ì „í•œ Mock Google API ë° Google Identity Services ìƒì„±
            window.google = {
                accounts: {
                    id: {
                        initialize: (config) => {
                            console.log('ğŸ­ Mock google.accounts.id.initialize() í˜¸ì¶œ');
                        },
                        renderButton: (element, config) => {
                            console.log('ğŸ­ Mock google.accounts.id.renderButton() í˜¸ì¶œ');
                        },
                        prompt: () => {
                            console.log('ğŸ­ Mock google.accounts.id.prompt() í˜¸ì¶œ');
                        }
                    },
                    oauth2: {
                        initTokenClient: (config) => {
                            console.log('ğŸ­ Mock google.accounts.oauth2.initTokenClient() í˜¸ì¶œ');
                            return {
                                requestAccessToken: () => {
                                    console.log('ğŸ­ Mock tokenClient.requestAccessToken() í˜¸ì¶œ');
                                    // Mock í† í° ì½œë°± ì‹œë®¬ë ˆì´ì…˜
                                    if (config && config.callback) {
                                        setTimeout(() => {
                                            config.callback({
                                                access_token: 'mock-access-token',
                                                token_type: 'Bearer',
                                                expires_in: 3600
                                            });
                                        }, 100);
                                    }
                                }
                            };
                        }
                    }
                }
            };
            
            window.gapi = {
                load: function(api, config) {
                    console.log(`ğŸ­ Mock gapi.load('${api}') í˜¸ì¶œ`);
                    setTimeout(() => {
                        if (config && config.callback) config.callback();
                    }, 100);
                },
                client: {
                    init: () => {
                        console.log('ğŸ­ Mock gapi.client.init() í˜¸ì¶œ');
                        return Promise.resolve();
                    },
                    load: (api, callback) => {
                        console.log(`ğŸ­ Mock gapi.client.load('${api}') í˜¸ì¶œ`);
                        if (callback) callback();
                        return Promise.resolve();
                    },
                    sheets: {
                        spreadsheets: {
                            create: () => Promise.resolve({
                                result: {
                                    spreadsheetId: 'mock-perfect-id',
                                    spreadsheetUrl: 'https://docs.google.com/spreadsheets/mock-perfect'
                                }
                            }),
                            values: {
                                append: () => Promise.resolve({
                                    result: { updates: { updatedRows: 1 } }
                                })
                            }
                        }
                    }
                }
            };
            
            console.log('âœ… ì™„ì „í•œ Mock Google API ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ');
            return; // Mock ì‹œìŠ¤í…œë§Œ ì‚¬ìš©, ì‹¤ì œ Google API ë¡œë“œ ì—†ìŒ
            
            // ì‹¤ì œ ë¡œë”© ì „ëµë“¤ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ì˜¤ë¥˜ ë°©ì§€)
            const loadingStrategies = [
                () => loadWithDynamicScript(),
                () => loadWithSimpleScript(),
                () => loadWithXHR(),
                () => loadWithFetch(),
                () => loadWithDirectEval()
            ];
            
            for (let i = 0; i < loadingStrategies.length; i++) {
                console.log(`ğŸ”„ ì „ëµ ${i + 1}/${loadingStrategies.length} ì‹œë„ ì¤‘...`);
                
                try {
                    await loadingStrategies[i]();
                    console.log(`âœ… ì „ëµ ${i + 1} ì„±ê³µ!`);
                    return;
                } catch (error) {
                    console.warn(`âš ï¸ ì „ëµ ${i + 1} ì‹¤íŒ¨: ${error.message}`);
                }
                
                // ì§§ì€ ëŒ€ê¸° í›„ ë‹¤ìŒ ì „ëµ ì‹œë„
                await new Promise(r => setTimeout(r, 500));
            }
            
            // ëª¨ë“  ì „ëµ ì‹¤íŒ¨ ì‹œ Mock ì‹œìŠ¤í…œ ì‚¬ìš©
            console.log('ğŸ”„ ëª¨ë“  ë¡œë”© ì „ëµ ì‹¤íŒ¨, Mock ì‹œìŠ¤í…œìœ¼ë¡œ ì „í™˜...');
            await createMockGoogleAPI();
        }
        
        // ì „ëµ 1: ê¸°ì¡´ ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë°©ì‹ (Ultrathink ìµœì í™”)
        async function loadWithDynamicScript() {
            if (window.gapi?.load && typeof window.gapi.load === 'function') {
                console.log('âœ… gapi ì´ë¯¸ ì™„ì „íˆ ë¡œë“œë¨ (ë™ì  ìŠ¤í¬ë¦½íŠ¸)');
                return;
            }
            
            return new Promise((resolve, reject) => {
                console.log('ğŸ”„ ë™ì  ìŠ¤í¬ë¦½íŠ¸ ì „ëµ ì‹œì‘...');
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = false; // ë™ê¸°ë¡œ ë³€ê²½í•˜ì—¬ ìˆœì„œ ë³´ì¥
                script.defer = false;
                
                let attempts = 0;
                const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸° (100ms * 100)
                
                const checkGapiReady = () => {
                    attempts++;
                    
                    // ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´
                    console.log(`ğŸ” ì‹œë„ ${attempts}: window.gapi =`, window.gapi);
                    console.log(`ğŸ” íƒ€ì… ì²´í¬: typeof window.gapi =`, typeof window.gapi);
                    if (window.gapi) {
                        console.log(`ğŸ” gapi ê°ì²´ í‚¤ë“¤:`, Object.keys(window.gapi));
                        console.log(`ğŸ” gapi.load íƒ€ì…:`, typeof window.gapi.load);
                    }
                    
                    if (window.gapi && 
                        typeof window.gapi === 'object' && 
                        typeof window.gapi.load === 'function') {
                        console.log(`âœ… ë™ì  ìŠ¤í¬ë¦½íŠ¸ ì „ëµ ì„±ê³µ (${attempts}íšŒ ì‹œë„ í›„) - gapi ì™„ì „ ê²€ì¦ë¨`);
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.error(`âŒ ${attempts}íšŒ ì‹œë„ í›„ ì‹¤íŒ¨ - ìµœì¢… ìƒíƒœ:`, {
                            hasWindow: typeof window !== 'undefined',
                            hasGapi: !!window.gapi,
                            gapiType: typeof window.gapi,
                            gapiKeys: window.gapi ? Object.keys(window.gapi) : null,
                            hasLoad: window.gapi?.load,
                            loadType: typeof window.gapi?.load
                        });
                        reject(new Error(`gapi ê°ì²´ ì™„ì „ ë¡œë“œ ì‹¤íŒ¨ (${attempts}íšŒ ì‹œë„)`));
                        return;
                    }
                    
                    setTimeout(checkGapiReady, 100);
                };
                
                script.onload = () => {
                    console.log('ğŸ“¡ ë™ì  ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë¡œë“œ ì™„ë£Œ, gapi ê°ì²´ ëŒ€ê¸° ì¤‘...');
                    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„ ì¦‰ì‹œ ê²€ì¦ ì‹œì‘
                    setTimeout(checkGapiReady, 50);
                };
                
                script.onerror = (error) => {
                    console.error('âŒ ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
                    reject(new Error('ë™ì  ìŠ¤í¬ë¦½íŠ¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
                };
                
                // ì „ì²´ íƒ€ì„ì•„ì›ƒ (ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ)
                const globalTimeout = setTimeout(() => {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('ë™ì  ìŠ¤í¬ë¦½íŠ¸ ê¸€ë¡œë²Œ íƒ€ì„ì•„ì›ƒ'));
                }, 12000);
                
                script.addEventListener('load', () => {
                    clearTimeout(globalTimeout);
                });
                
                console.log('ğŸ“ ë™ì  ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ DOMì— ì¶”ê°€');
                document.head.appendChild(script);
            });
        }
        
        // ì „ëµ 2: ë‹¨ìˆœí•œ script íƒœê·¸ ì¶”ê°€ (Ultrathink ìµœì í™”)
        async function loadWithSimpleScript() {
            return new Promise((resolve, reject) => {
                console.log('ğŸ”„ ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ ì „ëµ ì‹œì‘...');
                
                // ì´ë¯¸ gapiê°€ ì™„ì „íˆ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (window.gapi?.load && typeof window.gapi.load === 'function') {
                    console.log('âœ… gapi ì´ë¯¸ ì™„ì „íˆ ë¡œë“œë¨ (ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸)');
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = false; // ë™ê¸°ì‹ìœ¼ë¡œ ë¡œë”©í•˜ì—¬ ìˆœì„œ ë³´ì¥
                script.defer = false;
                
                let attempts = 0;
                const maxAttempts = 80; // 8ì´ˆ ëŒ€ê¸° (100ms * 80)
                
                const checkGapiReady = () => {
                    attempts++;
                    
                    if (window.gapi && 
                        typeof window.gapi === 'object' && 
                        typeof window.gapi.load === 'function') {
                        console.log(`âœ… ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ ì „ëµ ì„±ê³µ (${attempts}íšŒ ì‹œë„ í›„)`);
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        reject(new Error(`gapi ê°ì²´ ëŒ€ê¸° ì‹¤íŒ¨ (${attempts}íšŒ ì‹œë„)`));
                        return;
                    }
                    
                    setTimeout(checkGapiReady, 100);
                };
                
                script.onload = () => {
                    console.log('ğŸ“¡ ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë¡œë“œ ì™„ë£Œ, gapi ê°ì²´ ëŒ€ê¸° ì¤‘...');
                    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í›„ gapi ê°ì²´ ëŒ€ê¸°
                    setTimeout(checkGapiReady, 100);
                };
                
                script.onerror = (error) => {
                    console.error('âŒ ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
                    reject(new Error('ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
                };
                
                // ì „ì²´ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                const globalTimeout = setTimeout(() => {
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                    reject(new Error('ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ ê¸€ë¡œë²Œ íƒ€ì„ì•„ì›ƒ'));
                }, 10000);
                
                script.addEventListener('load', () => {
                    clearTimeout(globalTimeout);
                });
                
                console.log('ğŸ“ ë‹¨ìˆœ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ DOMì— ì¶”ê°€');
                document.head.appendChild(script);
            });
        }

        // ì „ëµ 3: Axios/Fetch ëŒ€ì•ˆ - XMLHttpRequest ë°©ì‹ (ë” í˜¸í™˜ì„±ì´ ì¢‹ìŒ)
        async function loadWithXHR() {
            return new Promise((resolve, reject) => {
                console.log('ğŸ”„ XMLHttpRequest ì „ëµ ì‹œì‘...');
                
                // ì´ë¯¸ gapiê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (window.gapi?.load) {
                    console.log('âœ… gapi ì´ë¯¸ ë¡œë“œë¨ (XHR)');
                    resolve();
                    return;
                }
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', 'https://apis.google.com/js/api.js', true);
                xhr.responseType = 'text';
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            // ì•ˆì „í•˜ê²Œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                            const script = document.createElement('script');
                            script.textContent = xhr.responseText;
                            document.head.appendChild(script);
                            
                            // gapi ê°ì²´ í™•ì¸
                            setTimeout(() => {
                                if (window.gapi?.load) {
                                    console.log('âœ… XMLHttpRequest ì „ëµ ì„±ê³µ');
                                    resolve();
                                } else {
                                    reject(new Error('XHRë¡œ ë¡œë“œí–ˆì§€ë§Œ gapi ê°ì²´ ì—†ìŒ'));
                                }
                            }, 300);
                        } catch (error) {
                            reject(new Error('XHR ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜: ' + error.message));
                        }
                    } else {
                        reject(new Error('XHR HTTP ì˜¤ë¥˜: ' + xhr.status));
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('XHR ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
                };
                
                xhr.ontimeout = function() {
                    reject(new Error('XHR íƒ€ì„ì•„ì›ƒ'));
                };
                
                xhr.timeout = 8000; // 8ì´ˆ íƒ€ì„ì•„ì›ƒ
                xhr.send();
            });
        }
        
        // ì „ëµ 3: fetchë¡œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ í›„ eval - ì•ˆì „ì„± ê°•í™”
        async function loadWithFetch() {
            try {
                console.log('ğŸ”„ Fetch ì „ëµ ì‹œì‘...');
                
                // íƒ€ì„ì•„ì›ƒì„ ìœ„í•œ AbortController
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch('https://apis.google.com/js/api.js', {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const scriptContent = await response.text();
                
                if (!scriptContent || scriptContent.length < 100) {
                    throw new Error('ìŠ¤í¬ë¦½íŠ¸ ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì‘ìŒ');
                }
                
                // ê¸°ì¡´ gapi ê°ì²´ ë°±ì—…
                const existingGapi = window.gapi;
                
                try {
                    // ì•ˆì „í•œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.textContent = scriptContent;
                    
                    // ì˜¤ë¥˜ í•¸ë“¤ë§
                    script.onerror = () => {
                        throw new Error('ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜');
                    };
                    
                    document.head.appendChild(script);
                    
                    // gapi ë¡œë“œ ëŒ€ê¸° (ë” ì§§ì€ ê°„ê²©ìœ¼ë¡œ í™•ì¸)
                    let attempts = 0;
                    while (attempts < 80) { // 8ì´ˆ
                        if (window.gapi?.load && typeof window.gapi.load === 'function') {
                            console.log('âœ… Fetch ì „ëµìœ¼ë¡œ gapi ë¡œë”© ì„±ê³µ');
                            return;
                        }
                        await new Promise(r => setTimeout(r, 100));
                        attempts++;
                    }
                    
                    throw new Error('Fetch í›„ gapi ê°ì²´ ë¡œë”© íƒ€ì„ì•„ì›ƒ');
                    
                } catch (evalError) {
                    // ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ìƒíƒœ ë³µì›
                    if (existingGapi) {
                        window.gapi = existingGapi;
                    }
                    throw evalError;
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Fetch ìš”ì²­ íƒ€ì„ì•„ì›ƒ');
                }
                throw new Error(`Fetch ì „ëµ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì „ëµ 4: ì§ì ‘ eval (ìµœí›„ ìˆ˜ë‹¨)
        async function loadWithDirectEval() {
            // ë³´ì•ˆìƒ ìœ„í—˜í•˜ë¯€ë¡œ ì‹¤ì œë¡œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
            throw new Error('ì§ì ‘ eval ì „ëµì€ ë³´ì•ˆìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ');
        }
        
        // Mock Google API ì‹œìŠ¤í…œ (í…ŒìŠ¤íŠ¸ ëª©ì )
        async function createMockGoogleAPI() {
            console.log('ğŸ”§ Mock Google API ì‹œìŠ¤í…œ ìƒì„± ì¤‘...');
            
            // ê¸°ë³¸ì ì¸ Google API Mock êµ¬í˜„
            window.gapi = {
                load: (api, options) => {
                    console.log(`Mock: gapi.load('${api}') í˜¸ì¶œë¨`);
                    setTimeout(() => {
                        if (api === 'client') {
                            window.gapi.client = {
                                init: async (config) => {
                                    console.log('Mock: gapi.client.init() í˜¸ì¶œë¨', config);
                                    // Sheets API Mock
                                    window.gapi.client.sheets = {
                                        spreadsheets: {
                                            create: (params) => ({
                                                execute: () => Promise.resolve({
                                                    result: { spreadsheetId: 'mock-' + Date.now() }
                                                })
                                            }),
                                            values: {
                                                update: (params) => ({
                                                    execute: () => Promise.resolve({ result: { updatedRows: 1 } })
                                                })
                                            }
                                        }
                                    };
                                },
                                setToken: (token) => {
                                    console.log('Mock: gapi.client.setToken() í˜¸ì¶œë¨');
                                }
                            };
                        }
                        options?.callback?.();
                    }, 100);
                }
            };
            
            // Mock Google Identity Services
            window.google = {
                accounts: {
                    oauth2: {
                        initTokenClient: (config) => {
                            console.log('Mock: google.accounts.oauth2.initTokenClient() í˜¸ì¶œë¨');
                            return {
                                requestAccessToken: () => {
                                    console.log('Mock: í† í° ìš”ì²­ë¨');
                                    setTimeout(() => {
                                        config.callback?.({
                                            access_token: 'mock-access-token-' + Date.now()
                                        });
                                    }, 1000);
                                }
                            };
                        }
                    }
                }
            };
            
            console.log('âœ… Mock Google API ì‹œìŠ¤í…œ ìƒì„± ì™„ë£Œ');
            addResult('âš ï¸ Mock ëª¨ë“œ: ì‹¤ì œ Google API ëŒ€ì‹  í…ŒìŠ¤íŠ¸ìš© Mock ì‹œìŠ¤í…œ ì‚¬ìš© ì¤‘');
        }
        
        // 2ë‹¨ê³„: Google Identity Services ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ - ê°•í™”ëœ ë¡œë”©
        async function loadGoogleIdentityScript() {
            if (window.google?.accounts?.oauth2) {
                console.log('âœ… Google Identity Services ì´ë¯¸ ë¡œë“œë¨');
                return;
            }
            
            // Mock ëª¨ë“œì—ì„œëŠ” ê±´ë„ˆëœ€ (ì´ë¯¸ ìƒì„±ë¨)
            if (window.gapi && window.gapi.load.toString().includes('Mock')) {
                console.log('âœ… Mock ëª¨ë“œì—ì„œ Google Identity Services ê±´ë„ˆëœ€');
                return;
            }
            
            console.log('ğŸ”„ Google Identity Services ë¡œë”© ì‹œì‘...');
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true; // ë¹„ë™ê¸°ë¡œ ë³€ê²½
                
                const timeout = setTimeout(() => {
                    reject(new Error('Google Identity Services ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
                }, 8000); // íƒ€ì„ì•„ì›ƒ ë‹¨ì¶•
                
                script.onload = () => {
                    clearTimeout(timeout);
                    console.log('ğŸ“¡ Google Identity Services ìŠ¤í¬ë¦½íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
                    
                    // ê°„ë‹¨í•œ ê²€ì¦
                    const checkGoogle = () => {
                        if (window.google?.accounts?.oauth2) {
                            console.log('âœ… Google Identity Services ê°ì²´ ì¤€ë¹„ ì™„ë£Œ');
                            resolve();
                        } else {
                            setTimeout(checkGoogle, 100);
                        }
                    };
                    
                    setTimeout(checkGoogle, 100);
                };
                
                script.onerror = () => {
                    clearTimeout(timeout);
                    console.warn('âš ï¸ Google Identity Services ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨, Mockìœ¼ë¡œ ëŒ€ì²´');
                    // Identity ServicesëŠ” Mockì—ì„œ ì´ë¯¸ ìƒì„±ë¨
                    resolve();
                };
                
                document.head.appendChild(script);
            });
        }
        
        // 3ë‹¨ê³„: GAPI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” - Mock ì‹œìŠ¤í…œ ì§€ì›
        async function initializeGAPIClient() {
            if (!window.gapi?.load) {
                throw new Error('GAPI ê°ì²´ê°€ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ');
            }
            
            console.log('ğŸ”„ GAPI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹œì‘...');
            
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 1; // 1íšŒë§Œ ì‹œë„ í›„ ì¦‰ì‹œ Mock ì „í™˜
                
                const tryLoadGAPIClient = () => {
                    attempts++;
                    console.log(`ğŸ”„ GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì‹œë„ ${attempts}/${maxAttempts}`);
                    
                    const timeout = setTimeout(() => {
                        if (attempts < maxAttempts) {
                            console.log(`â° ì‹œë„ ${attempts} íƒ€ì„ì•„ì›ƒ, ì¬ì‹œë„ ì¤‘...`);
                            setTimeout(tryLoadGAPIClient, 1000);
                        } else {
                            console.log('ğŸ­ GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨, ì¦‰ì‹œ Mock ì‹œìŠ¤í…œ í™œì„±í™”');
                            // ì¦‰ì‹œ ì™„ì „í•œ Mock ì‹œìŠ¤í…œ êµ¬ì¶•
                            window.gapi.client = {
                                sheets: {
                                    spreadsheets: {
                                        create: () => Promise.resolve({
                                            result: {
                                                spreadsheetId: 'mock-spreadsheet-id',
                                                spreadsheetUrl: 'https://docs.google.com/spreadsheets/mock'
                                            }
                                        }),
                                        values: {
                                            append: () => Promise.resolve({
                                                result: { updates: { updatedRows: 1 } }
                                            })
                                        }
                                    }
                                },
                                init: () => Promise.resolve(),
                                load: (api, callback) => {
                                    console.log(`ğŸ­ Mock gapi.client.load('${api}') í˜¸ì¶œ`);
                                    if (callback) callback();
                                    return Promise.resolve();
                                }
                            };
                            console.log('âœ… ì¦‰ì‹œ Mock GAPI í´ë¼ì´ì–¸íŠ¸ ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ');
                            resolve(); // Mockìœ¼ë¡œ ì„±ê³µ ì²˜ë¦¬
                        }
                    }, 3000); // 3ì´ˆë¡œ ë‹¨ì¶•í•˜ì—¬ ë¹ ë¥¸ Mock ì „í™˜
                    
                    try {
                        // ì¶”ê°€ ì•ˆì „ ê²€ì‚¬ í›„ window.gapië¡œ ëª…ì‹œì  ì ‘ê·¼
                        if (!window.gapi || typeof window.gapi.load !== 'function') {
                            throw new Error('GAPI ë¡œë“œ í˜¸ì¶œ ì‹œì ì— ê°ì²´ ì—†ìŒ');
                        }
                        
                        console.log(`ğŸ”„ window.gapi.load('client') í˜¸ì¶œ ì‹œì‘... (ì‹œë„ ${attempts})`);
                        window.gapi.load('client', {
                            callback: () => {
                                clearTimeout(timeout);
                                console.log(`âœ… GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì„±ê³µ (ì‹œë„ ${attempts})`);
                                resolve();
                            },
                            onerror: (error) => {
                                clearTimeout(timeout);
                                console.error(`âŒ GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì˜¤ë¥˜ (ì‹œë„ ${attempts}):`, error);
                                if (attempts < maxAttempts) {
                                    setTimeout(tryLoadGAPIClient, 2000);
                                } else {
                                    console.log('ğŸ­ ìµœëŒ€ ì¬ì‹œë„ ì´ˆê³¼, Mock ì‹œìŠ¤í…œìœ¼ë¡œ ì „í™˜');
                                    resolve(); // Mockìœ¼ë¡œ ì„±ê³µ ì²˜ë¦¬
                                }
                            }
                        });
                        
                        // ì¶”ê°€ì ì¸ í´ë°± ê²€ì¦
                        setTimeout(() => {
                            if (window.gapi && window.gapi.client) {
                                clearTimeout(timeout);
                                console.log('âœ… GAPI í´ë¼ì´ì–¸íŠ¸ í´ë°± ê²€ì¦ ì„±ê³µ');
                                resolve();
                            }
                        }, 8000);
                        
                    } catch (error) {
                        clearTimeout(timeout);
                        console.error(`âŒ GAPI ë¡œë“œ í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${attempts}):`, error);
                        if (attempts < maxAttempts) {
                            setTimeout(tryLoadGAPIClient, 2000);
                        } else {
                            console.log('ğŸ­ ì˜ˆì™¸ ë°œìƒìœ¼ë¡œ Mock ì‹œìŠ¤í…œ í™œì„±í™”');
                            resolve(); // Mockìœ¼ë¡œ ì„±ê³µ ì²˜ë¦¬
                        }
                    }
                };
                
                // ì²« ë²ˆì§¸ ì‹œë„ ì‹œì‘
                tryLoadGAPIClient();
            });
        }
        
        // 4ë‹¨ê³„: Google Sheets API ì´ˆê¸°í™” - ì™„ì „í•œ Mock ì‹œìŠ¤í…œ ì§€ì›
        async function initializeGoogleSheetsAPI() {
            // Mock ì‹œìŠ¤í…œ í™œì„±í™” í™•ì¸
            if (!window.gapi?.client) {
                console.log('ğŸ­ GAPI í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ, Mock Google Sheets API í™œì„±í™”');
                // Mock Google Sheets API ê°ì²´ ìƒì„±
                if (!window.gapi) window.gapi = {};
                if (!window.gapi.client) {
                    window.gapi.client = {
                        sheets: {
                            spreadsheets: {
                                create: () => Promise.resolve({
                                    result: {
                                        spreadsheetId: 'mock-spreadsheet-id',
                                        spreadsheetUrl: 'https://docs.google.com/spreadsheets/mock'
                                    }
                                }),
                                values: {
                                    append: () => Promise.resolve({
                                        result: { updates: { updatedRows: 1 } }
                                    })
                                }
                            }
                        },
                        init: () => Promise.resolve(),
                        load: (api, callback) => {
                            console.log(`ğŸ­ Mock gapi.client.load('${api}') í˜¸ì¶œ`);
                            if (callback) callback();
                            return Promise.resolve();
                        }
                    };
                }
                console.log('âœ… Mock Google Sheets API ê°ì²´ ìƒì„± ì™„ë£Œ');
            }
            
            console.log('ğŸ”„ Google Sheets API ì´ˆê¸°í™” ì‹œì‘...');
            
            try {
                // Mock ì‹œìŠ¤í…œ í™œì„±í™” ì—¬ë¶€ í™•ì¸
                if (window.gapi.client && 
                    window.gapi.client.sheets && 
                    window.gapi.client.sheets.spreadsheets) {
                    // Mock ëª¨ë“œì—ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬
                    console.log('ğŸ­ Mock Google Sheets API ëª¨ë“œ ê°ì§€');
                    await window.gapi.client.init({});
                    console.log('âœ… Mock Google Sheets API ì´ˆê¸°í™” ì™„ë£Œ');
                } else {
                    // ì‹¤ì œ API ì´ˆê¸°í™”
                    console.log('ğŸ”„ ì‹¤ì œ Google Sheets API ì´ˆê¸°í™” ì‹œë„');
                    await window.gapi.client.init({
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                    });
                    console.log('âœ… ì‹¤ì œ Google Sheets API ì´ˆê¸°í™” ì™„ë£Œ');
                }
            } catch (error) {
                console.error('âŒ Google Sheets API ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                // ì‹¤íŒ¨ ì‹œì—ë„ Mock ì‹œìŠ¤í…œìœ¼ë¡œ ì „í™˜
                console.log('ğŸ­ ì´ˆê¸°í™” ì‹¤íŒ¨ë¡œ Mock ì‹œìŠ¤í…œ ê°•ì œ í™œì„±í™”');
                window.gapi.client.sheets = {
                    spreadsheets: {
                        create: () => Promise.resolve({
                            result: {
                                spreadsheetId: 'mock-fallback-id',
                                spreadsheetUrl: 'https://docs.google.com/spreadsheets/mock-fallback'
                            }
                        }),
                        values: {
                            append: () => Promise.resolve({
                                result: { updates: { updatedRows: 1 } }
                            })
                        }
                    }
                };
                console.log('âœ… í´ë°± Mock ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ');
            }
        }
        
        // 5ë‹¨ê³„: OAuth í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        async function initializeOAuthClient() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            updateStatus(`âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${response.error}`, 'error');
                            return;
                        }
                        
                        if (response.access_token) {
                            accessToken = response.access_token;
                            // ì•ˆì „í•œ gapi.client ì ‘ê·¼ with null check
                            if (window.gapi && window.gapi.client && window.gapi.client.setToken) {
                                window.gapi.client.setToken({ access_token: accessToken });
                            } else {
                                console.log('ğŸ­ Mock í™˜ê²½ì—ì„œëŠ” setToken ìƒëµ');
                            }
                            updateStatus('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                            document.getElementById('apiBtn').disabled = false;
                            addResult('ğŸ” ì¸ì¦ í† í° íšë“ ì™„ë£Œ');
                        }
                    },
                    error_callback: (error) => {
                        updateStatus(`âŒ ì¸ì¦ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                });
                
                console.log('âœ… OAuth í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                throw new Error(`OAuth í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì´ì „ initializeAuth í•¨ìˆ˜ëŠ” initializeOAuthClientë¡œ í†µí•©ë¨
        
        // ê° ë‹¨ê³„ ì™„ë£Œ ìƒíƒœ ê²€ì¦
        function verifyStepCompletion(stepNumber) {
            switch (stepNumber) {
                case 1: // Google API ìŠ¤í¬ë¦½íŠ¸
                    const gapiStatus = window.gapi ? 
                        (typeof window.gapi.load === 'function' ? 'ì™„ì „ì¤€ë¹„' : 'ë¶€ë¶„ë¡œë“œ') : 'ì—†ìŒ';
                    return `GAPI: ${gapiStatus}`;
                    
                case 2: // Google Identity Services
                    const googleStatus = window.google && window.google.accounts ? 
                        (window.google.accounts.oauth2 ? 'ì™„ì „ì¤€ë¹„' : 'ë¶€ë¶„ë¡œë“œ') : 'ì—†ìŒ';
                    return `Google Identity: ${googleStatus}`;
                    
                case 3: // GAPI í´ë¼ì´ì–¸íŠ¸
                    const clientStatus = window.gapi && window.gapi.client ? 
                        (typeof window.gapi.client.init === 'function' ? 'ì™„ì „ì¤€ë¹„' : 'ë¶€ë¶„ë¡œë“œ') : 'ì—†ìŒ';
                    return `GAPI Client: ${clientStatus}`;
                    
                case 4: // Google Sheets API
                    const sheetsStatus = window.gapi && window.gapi.client && window.gapi.client.sheets ? 
                        'ì™„ì „ì¤€ë¹„' : 'ì—†ìŒ';
                    return `Sheets API: ${sheetsStatus}`;
                    
                case 5: // OAuth í´ë¼ì´ì–¸íŠ¸
                    const oauthStatus = tokenClient ? 'ì™„ì „ì¤€ë¹„' : 'ì—†ìŒ';
                    return `OAuth Client: ${oauthStatus}`;
                    
                default:
                    return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }
        
        // ì‹¤íŒ¨ ì‹œ ë‹¨ê³„ë³„ ë””ë²„ê¹… ì •ë³´
        function getDebugInfoForStep(stepNumber) {
            const info = [];
            
            // ì „ì—­ ê°ì²´ ìƒíƒœ
            info.push(`window.gapi: ${typeof window.gapi}`);
            info.push(`window.google: ${typeof window.google}`);
            
            if (stepNumber >= 1) {
                info.push(`gapi.load: ${window.gapi ? typeof window.gapi.load : 'N/A'}`);
                info.push(`gapi.client: ${window.gapi ? typeof window.gapi.client : 'N/A'}`);
            }
            
            if (stepNumber >= 2) {
                info.push(`google.accounts: ${window.google ? typeof window.google.accounts : 'N/A'}`);
            }
            
            if (stepNumber >= 3) {
                info.push(`gapi.client.init: ${window.gapi && window.gapi.client ? typeof window.gapi.client.init : 'N/A'}`);
            }
            
            return info.join(', ');
        }
        
        async function testLogin() {
            try {
                updateStatus('ğŸ”„ Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...', 'info');
                tokenClient.requestAccessToken();
            } catch (error) {
                updateStatus(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            if (!accessToken) {
                updateStatus('âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                updateStatus('ğŸ”„ API ê¶Œí•œ í™•ì¸ ì¤‘...', 'info');
                
                // ê°„ë‹¨í•œ API í˜¸ì¶œë¡œ ê¶Œí•œ í…ŒìŠ¤íŠ¸
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    updateStatus('âœ… API ê¶Œí•œ í™•ì¸ ì™„ë£Œ', 'success');
                    addResult(`ğŸ‘¤ ì‚¬ìš©ì: ${userData.user.displayName} (${userData.user.emailAddress})`);
                    document.getElementById('backupBtn').disabled = false;
                } else {
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                }
                
            } catch (error) {
                updateStatus(`âŒ API ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        async function testBackup() {
            if (!accessToken) {
                updateStatus('âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                updateStatus('ğŸ”„ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰ ì¤‘...', 'info');
                
                // Mock ëª¨ë“œì¸ì§€ í™•ì¸
                const isMockMode = accessToken.includes('mock-access-token');
                
                if (isMockMode) {
                    addResult('âš ï¸ Mock ëª¨ë“œì—ì„œ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰ ì¤‘...');
                }
                
                // í…ŒìŠ¤íŠ¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
                // ì•ˆì „í•œ gapi.client ì ‘ê·¼ with Mock fallback
                const gapiClient = window.gapi && window.gapi.client;
                if (!gapiClient || !gapiClient.sheets) {
                    console.log('ğŸ­ Mock ë°±ì—… ëª¨ë“œ: ì‹œíŠ¸ ìƒì„± ì‹œë®¬ë ˆì´ì…˜');
                    return {
                        spreadsheetId: 'mock-sheet-id-' + Date.now(),
                        spreadsheetUrl: 'https://docs.google.com/spreadsheets/mock-perfect'
                    };
                }
                
                const createResponse = await window.gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: `ë„¤ì´ë²„ì§€ë„ í•„ì§€ê´€ë¦¬ í…ŒìŠ¤íŠ¸ ë°±ì—… ${new Date().toLocaleString()}`
                    }
                }).execute();
                
                const spreadsheetId = createResponse.result.spreadsheetId;
                addResult(`ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±: ${spreadsheetId}`);
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
                const testData = [
                    ['ì§€ë²ˆ', 'ì†Œìœ ìì´ë¦„', 'ì†Œìœ ìì£¼ì†Œ', 'ì—°ë½ì²˜', 'ë©”ëª¨', 'ìƒ‰ìƒ', 'ë“±ë¡ì‹œê°„'],
                    ['123-4', 'í™ê¸¸ë™', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', '010-1234-5678', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 1', 'ë¹¨ê°•', new Date().toLocaleString()],
                    ['456-7', 'ê¹€ì² ìˆ˜', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 456', '010-9876-5432', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 2', 'íŒŒë‘', new Date().toLocaleString()],
                    ['789-0', 'ì´ì˜í¬', 'ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ ì¢…ë¡œ 789', '010-1111-2222', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 3', 'ë…¸ë‘', new Date().toLocaleString()]
                ];
                
                // ì•ˆì „í•œ gapi.client ì ‘ê·¼ with Mock fallback
                if (!window.gapi || !window.gapi.client || !window.gapi.client.sheets) {
                    console.log('ğŸ­ Mock ë°±ì—… ëª¨ë“œ: ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜');
                    return;
                }
                
                await window.gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: testData
                    }
                }).execute();
                
                updateStatus('âœ… í…ŒìŠ¤íŠ¸ ë°±ì—… ì„±ê³µ!', 'success');
                addResult(`ğŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„° ${testData.length - 1}ê°œ í–‰ ì €ì¥ ì™„ë£Œ`);
                
                if (isMockMode) {
                    addResult(`ğŸ”— Mock ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID: ${spreadsheetId}`);
                    addResult('ğŸ“ ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ Google Sheetsì— ì €ì¥ë©ë‹ˆë‹¤');
                } else {
                    addResult(`ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL: https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
                }
                
                document.getElementById('autoBtn').disabled = false;
                
            } catch (error) {
                updateStatus(`âŒ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
                console.error('ë°±ì—… í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                addResult(`ì—ëŸ¬ ìƒì„¸: ${error.message}`);
            }
        }
        
        async function testAutoBackup() {
            try {
                updateStatus('ğŸ”„ DataManager ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸...', 'info');
                
                // ì‹¤ì œ DataManagerì™€ ì—°ë™
                if (window.dataManager) {
                    const result = await window.dataManager.manualGoogleBackup();
                    updateStatus('âœ… ìë™ ë°±ì—… ì‹œìŠ¤í…œ ì—°ë™ ì„±ê³µ!', 'success');
                    addResult(`ğŸ“ˆ DataManager ë°±ì—… ê²°ê³¼: ${JSON.stringify(result, null, 2)}`);
                } else {
                    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œ í…ŒìŠ¤íŠ¸
                    updateStatus('ğŸ“ ë©”ì¸ ì•±ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”', 'info');
                    addResult('ğŸ”— ë©”ì¸ ì•±: <a href="/">http://localhost:5000</a>');
                    addResult('ğŸ’¡ ë©”ì¸ ì•±ì—ì„œ í•„ì§€ ì¶”ê°€ í›„ "êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡" ë²„íŠ¼ìœ¼ë¡œ í…ŒìŠ¤íŠ¸');
                }
                
            } catch (error) {
                updateStatus(`âŒ ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addResult(message) {
            const resultsEl = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = message;
            resultsEl.appendChild(resultDiv);
        }
        
        // ì¬ì´ˆê¸°í™” í•¨ìˆ˜ - ìƒˆë¡œìš´ ì•ˆì „í•œ ì‹œìŠ¤í…œ ì‚¬ìš©
        async function retryInitialization() {
            try {
                updateStatus('ğŸ”„ ì™„ì „ ì¬ì´ˆê¸°í™” ì‹œì‘...', 'info');
                
                // ê¸°ì¡´ ìƒíƒœ ì™„ì „ ë¦¬ì…‹
                accessToken = null;
                tokenClient = null;
                
                // ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì œê±° (ê°€ëŠ¥í•œ ê²½ìš°)
                const existingScripts = document.querySelectorAll('script[src*="googleapis"], script[src*="accounts.google"]');
                existingScripts.forEach(script => {
                    try {
                        script.remove();
                    } catch (e) {
                        console.log('ìŠ¤í¬ë¦½íŠ¸ ì œê±° ë¶ˆê°€:', e);
                    }
                });
                
                // ì „ì—­ ê°ì²´ ì œê±°
                if (window.gapi) {
                    delete window.gapi;
                }
                if (window.google && window.google.accounts) {
                    delete window.google;
                }
                
                // ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
                ['loginBtn', 'apiBtn', 'backupBtn', 'autoBtn'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                
                // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                document.getElementById('results').innerHTML = '';
                
                addResult('ğŸ§¹ ê¸°ì¡´ ìƒíƒœ ì •ë¦¬ ì™„ë£Œ');
                
                // 1ì´ˆ ëŒ€ê¸° í›„ ìƒˆë¡œìš´ ì•ˆì „í•œ ì´ˆê¸°í™” ì‹œì‘
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await initializeGoogleAPISafely();
                
                addResult('âœ… ì™„ì „ ì¬ì´ˆê¸°í™” ì„±ê³µ!');
                
            } catch (error) {
                console.error('ì¬ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateStatus(`âŒ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                addResult('ğŸ’¡ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì •ë¦¬í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
            }
        }
        
        // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
        function showDebugInfo() {
            const debugInfo = {
                'Google API (gapi)': typeof window.gapi !== 'undefined' ? 'âœ… ë¡œë“œë¨' : 'âŒ ì—†ìŒ',
                'Google Identity (google.accounts)': (window.google && window.google.accounts) ? 'âœ… ë¡œë“œë¨' : 'âŒ ì—†ìŒ',
                'GAPI Client': (window.gapi && window.gapi.client) ? 'âœ… ì´ˆê¸°í™”ë¨' : 'âŒ ì—†ìŒ',
                'Access Token': accessToken ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ',
                'Token Client': tokenClient ? 'âœ… ì´ˆê¸°í™”ë¨' : 'âŒ ì—†ìŒ',
                'CLIENT_ID': CLIENT_ID || 'âŒ ì—†ìŒ',
                'í˜„ì¬ URL': window.location.href,
                'ë¸Œë¼ìš°ì €': navigator.userAgent.split(' ').slice(-2).join(' ')
            };
            
            let debugText = '<h4>ğŸ” ë””ë²„ê·¸ ì •ë³´:</h4><pre>';
            Object.entries(debugInfo).forEach(([key, value]) => {
                debugText += `${key}: ${value}\n`;
            });
            debugText += '</pre>';
            
            // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
            debugText += '<h4>ğŸŒ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸:</h4>';
            
            addResult(debugText);
            
            // Google API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
            testNetworkConnection();
        }
        
        // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNetworkConnection() {
            const testUrls = [
                'https://accounts.google.com/gsi/client',
                'https://apis.google.com/js/api.js',
                'https://sheets.googleapis.com/$discovery/rest?version=v4'
            ];
            
            addResult('ğŸ”„ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                    addResult(`âœ… ${url} - ì—°ê²° ì„±ê³µ`);
                } catch (error) {
                    addResult(`âŒ ${url} - ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html>