<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets ë°±ì—… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #3367d6; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Google Sheets ë°±ì—… ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        
        <div id="authStatus" class="status info">
            ğŸ“¡ Google API ë¡œë”© ì¤‘...
        </div>
        
        <div class="result">
            <h3>í…ŒìŠ¤íŠ¸ ë‹¨ê³„:</h3>
            <ol>
                <li><strong>Google ë¡œê·¸ì¸</strong> - OAuth ì¸ì¦ í…ŒìŠ¤íŠ¸</li>
                <li><strong>API ê¶Œí•œ í™•ì¸</strong> - Sheets API ì ‘ê·¼ ê¶Œí•œ</li>
                <li><strong>í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰</strong> - ìƒ˜í”Œ ë°ì´í„°ë¡œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±</li>
                <li><strong>DataManager í†µí•©</strong> - ìë™ ë°±ì—… ì‹œìŠ¤í…œ ì—°ë™</li>
            </ol>
        </div>
        
        <div>
            <button id="loginBtn" onclick="testLogin()" disabled>1ï¸âƒ£ Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button id="apiBtn" onclick="testAPI()" disabled>2ï¸âƒ£ API ê¶Œí•œ í™•ì¸</button>
            <button id="backupBtn" onclick="testBackup()" disabled>3ï¸âƒ£ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰</button>
            <button id="autoBtn" onclick="testAutoBackup()" disabled>4ï¸âƒ£ ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div style="margin-top: 15px;">
            <button onclick="location.reload()" style="background: #28a745;">ğŸ”„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="retryInitialization()" style="background: #ffc107; color: black;">âš¡ API ì¬ì´ˆê¸°í™”</button>
            <button onclick="showDebugInfo()" style="background: #6c757d;">ğŸ” ë””ë²„ê·¸ ì •ë³´</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        let gapi;
        let tokenClient;
        let accessToken = null;
        
        const CLIENT_ID = '506368463001-um0b25os2vlep7mumonf63pcm9c9a0n3.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            await loadGoogleAPI();
            initializeAuth();
        });
        
        async function loadGoogleAPI() {
            try {
                updateStatus('ğŸ”„ Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì¤‘...', 'info');
                
                // Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
                if (!window.gapi) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://apis.google.com/js/api.js';
                        script.onload = () => {
                            console.log('âœ… Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨');
                            resolve();
                        };
                        script.onerror = (error) => {
                            console.error('âŒ Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                            reject(new Error('Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                        };
                        document.head.appendChild(script);
                    });
                }
                
                // gapi ê°ì²´ê°€ ì‚¬ìš© ê°€ëŠ¥í•  ë•Œê¹Œì§€ ëŒ€ê¸°
                await new Promise((resolve, reject) => {
                    let attempts = 0;
                    const checkGapi = () => {
                        attempts++;
                        console.log(`GAPI í™•ì¸ ì‹œë„ ${attempts}/50`);
                        
                        if (window.gapi && typeof window.gapi.load === 'function') {
                            console.log('âœ… GAPI ê°ì²´ ì‚¬ìš© ê°€ëŠ¥');
                            resolve();
                        } else if (attempts >= 50) {
                            reject(new Error('GAPI ê°ì²´ ë¡œë”© íƒ€ì„ì•„ì›ƒ'));
                        } else {
                            setTimeout(checkGapi, 100);
                        }
                    };
                    checkGapi();
                });
                
                updateStatus('ğŸ”„ Google API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...', 'info');
                
                // GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ
                await new Promise((resolve, reject) => {
                    try {
                        gapi.load('client', {
                            callback: () => {
                                console.log('âœ… GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œë¨');
                                resolve();
                            },
                            onerror: (error) => {
                                console.error('âŒ GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                                reject(new Error('GAPI í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                            }
                        });
                    } catch (error) {
                        reject(error);
                    }
                });
                
                // Google Sheets API ì´ˆê¸°í™”
                await gapi.client.init({
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                });
                
                console.log('âœ… Google Sheets API ì´ˆê¸°í™” ì™„ë£Œ');
                updateStatus('âœ… Google API ë¡œë”© ì™„ë£Œ', 'success');
                document.getElementById('loginBtn').disabled = false;
                
            } catch (error) {
                console.error('âŒ Google API ë¡œë”© ì „ì²´ ì‹¤íŒ¨:', error);
                updateStatus(`âŒ Google API ë¡œë”© ì‹¤íŒ¨: ${error.message}`, 'error');
                addResult(`ğŸ” í•´ê²°ë°©ë²•: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì •ë¦¬í•´ë³´ì„¸ìš”.`);
            }
        }
        
        function initializeAuth() {
            try {
                // Google Identity Services ì‚¬ìš© ê°€ëŠ¥ í™•ì¸
                if (!window.google || !window.google.accounts) {
                    updateStatus('âš ï¸ Google Identity Services ë¡œë”© ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”', 'info');
                    
                    // 3ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„
                    setTimeout(() => {
                        if (window.google && window.google.accounts) {
                            initializeAuth();
                        } else {
                            updateStatus('âŒ Google Identity Services ë¡œë“œ ì‹¤íŒ¨', 'error');
                            addResult('ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                        }
                    }, 3000);
                    return;
                }
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            updateStatus(`âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${response.error}`, 'error');
                            return;
                        }
                        
                        if (response.access_token) {
                            accessToken = response.access_token;
                            gapi.client.setToken({ access_token: accessToken });
                            updateStatus('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                            document.getElementById('apiBtn').disabled = false;
                            addResult('ğŸ” ì¸ì¦ í† í° íšë“ ì™„ë£Œ');
                        }
                    },
                    error_callback: (error) => {
                        updateStatus(`âŒ ì¸ì¦ ì´ˆê¸°í™” ì˜¤ë¥˜: ${error}`, 'error');
                    }
                });
                
                console.log('âœ… Google ì¸ì¦ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateStatus(`âŒ ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            try {
                updateStatus('ğŸ”„ Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...', 'info');
                tokenClient.requestAccessToken();
            } catch (error) {
                updateStatus(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            if (!accessToken) {
                updateStatus('âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                updateStatus('ğŸ”„ API ê¶Œí•œ í™•ì¸ ì¤‘...', 'info');
                
                // ê°„ë‹¨í•œ API í˜¸ì¶œë¡œ ê¶Œí•œ í…ŒìŠ¤íŠ¸
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    updateStatus('âœ… API ê¶Œí•œ í™•ì¸ ì™„ë£Œ', 'success');
                    addResult(`ğŸ‘¤ ì‚¬ìš©ì: ${userData.user.displayName} (${userData.user.emailAddress})`);
                    document.getElementById('backupBtn').disabled = false;
                } else {
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                }
                
            } catch (error) {
                updateStatus(`âŒ API ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        async function testBackup() {
            if (!accessToken) {
                updateStatus('âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                updateStatus('ğŸ”„ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤í–‰ ì¤‘...', 'info');
                
                // í…ŒìŠ¤íŠ¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
                const createResponse = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: `ë„¤ì´ë²„ì§€ë„ í•„ì§€ê´€ë¦¬ í…ŒìŠ¤íŠ¸ ë°±ì—… ${new Date().toLocaleString()}`
                    }
                });
                
                const spreadsheetId = createResponse.result.spreadsheetId;
                addResult(`ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±: ${spreadsheetId}`);
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
                const testData = [
                    ['ì§€ë²ˆ', 'ì†Œìœ ìì´ë¦„', 'ì†Œìœ ìì£¼ì†Œ', 'ì—°ë½ì²˜', 'ë©”ëª¨', 'ìƒ‰ìƒ', 'ë“±ë¡ì‹œê°„'],
                    ['123-4', 'í™ê¸¸ë™', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', '010-1234-5678', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 1', 'ë¹¨ê°•', new Date().toLocaleString()],
                    ['456-7', 'ê¹€ì² ìˆ˜', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ëŒ€ë¡œ 456', '010-9876-5432', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 2', 'íŒŒë‘', new Date().toLocaleString()],
                    ['789-0', 'ì´ì˜í¬', 'ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ ì¢…ë¡œ 789', '010-1111-2222', 'í…ŒìŠ¤íŠ¸ í•„ì§€ 3', 'ë…¸ë‘', new Date().toLocaleString()]
                ];
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: spreadsheetId,
                    range: 'A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: testData
                    }
                });
                
                updateStatus('âœ… í…ŒìŠ¤íŠ¸ ë°±ì—… ì„±ê³µ!', 'success');
                addResult(`ğŸ‰ í…ŒìŠ¤íŠ¸ ë°ì´í„° ${testData.length - 1}ê°œ í–‰ ì €ì¥ ì™„ë£Œ`);
                addResult(`ğŸ”— ìŠ¤í”„ë ˆë“œì‹œíŠ¸ URL: https://docs.google.com/spreadsheets/d/${spreadsheetId}`);
                
                document.getElementById('autoBtn').disabled = false;
                
            } catch (error) {
                updateStatus(`âŒ í…ŒìŠ¤íŠ¸ ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
                addResult(`ì—ëŸ¬ ìƒì„¸: ${JSON.stringify(error, null, 2)}`);
            }
        }
        
        async function testAutoBackup() {
            try {
                updateStatus('ğŸ”„ DataManager ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸...', 'info');
                
                // ì‹¤ì œ DataManagerì™€ ì—°ë™
                if (window.dataManager) {
                    const result = await window.dataManager.manualGoogleBackup();
                    updateStatus('âœ… ìë™ ë°±ì—… ì‹œìŠ¤í…œ ì—°ë™ ì„±ê³µ!', 'success');
                    addResult(`ğŸ“ˆ DataManager ë°±ì—… ê²°ê³¼: ${JSON.stringify(result, null, 2)}`);
                } else {
                    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œ í…ŒìŠ¤íŠ¸
                    updateStatus('ğŸ“ ë©”ì¸ ì•±ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‹¤ì œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”', 'info');
                    addResult('ğŸ”— ë©”ì¸ ì•±: <a href="/">http://localhost:5000</a>');
                    addResult('ğŸ’¡ ë©”ì¸ ì•±ì—ì„œ í•„ì§€ ì¶”ê°€ í›„ "êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡" ë²„íŠ¼ìœ¼ë¡œ í…ŒìŠ¤íŠ¸');
                }
                
            } catch (error) {
                updateStatus(`âŒ ìë™ ë°±ì—… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('authStatus');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function addResult(message) {
            const resultsEl = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = message;
            resultsEl.appendChild(resultDiv);
        }
        
        // ì¬ì´ˆê¸°í™” í•¨ìˆ˜
        async function retryInitialization() {
            try {
                updateStatus('ğŸ”„ API ì¬ì´ˆê¸°í™” ì‹œì‘...', 'info');
                
                // ê¸°ì¡´ ìƒíƒœ ë¦¬ì…‹
                accessToken = null;
                tokenClient = null;
                
                // ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
                ['loginBtn', 'apiBtn', 'backupBtn', 'autoBtn'].forEach(id => {
                    document.getElementById(id).disabled = true;
                });
                
                // ë‹¤ì‹œ ì´ˆê¸°í™”
                await loadGoogleAPI();
                initializeAuth();
                
                addResult('ğŸ”„ ì¬ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                updateStatus(`âŒ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
        function showDebugInfo() {
            const debugInfo = {
                'Google API (gapi)': typeof window.gapi !== 'undefined' ? 'âœ… ë¡œë“œë¨' : 'âŒ ì—†ìŒ',
                'Google Identity (google.accounts)': (window.google && window.google.accounts) ? 'âœ… ë¡œë“œë¨' : 'âŒ ì—†ìŒ',
                'GAPI Client': (window.gapi && window.gapi.client) ? 'âœ… ì´ˆê¸°í™”ë¨' : 'âŒ ì—†ìŒ',
                'Access Token': accessToken ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ',
                'Token Client': tokenClient ? 'âœ… ì´ˆê¸°í™”ë¨' : 'âŒ ì—†ìŒ',
                'CLIENT_ID': CLIENT_ID || 'âŒ ì—†ìŒ',
                'í˜„ì¬ URL': window.location.href,
                'ë¸Œë¼ìš°ì €': navigator.userAgent.split(' ').slice(-2).join(' ')
            };
            
            let debugText = '<h4>ğŸ” ë””ë²„ê·¸ ì •ë³´:</h4><pre>';
            Object.entries(debugInfo).forEach(([key, value]) => {
                debugText += `${key}: ${value}\n`;
            });
            debugText += '</pre>';
            
            // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
            debugText += '<h4>ğŸŒ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸:</h4>';
            
            addResult(debugText);
            
            // Google API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
            testNetworkConnection();
        }
        
        // ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testNetworkConnection() {
            const testUrls = [
                'https://accounts.google.com/gsi/client',
                'https://apis.google.com/js/api.js',
                'https://sheets.googleapis.com/$discovery/rest?version=v4'
            ];
            
            addResult('ğŸ”„ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                    addResult(`âœ… ${url} - ì—°ê²° ì„±ê³µ`);
                } catch (error) {
                    addResult(`âŒ ${url} - ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                }
            }
        }
    </script>
</body>
</html>