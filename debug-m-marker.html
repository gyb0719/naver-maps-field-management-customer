<!DOCTYPE html>
<html>
<head>
    <title>ğŸ¯ M ë§ˆì»¤ ë””ë²„ê¹… ë„êµ¬</title>
    <meta charset="utf-8">
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background: #f5f5f5; }
        .debug-panel { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
        .step { border-left: 4px solid #007bff; padding-left: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¯ M ë§ˆì»¤ ë””ë²„ê¹… ë„êµ¬ - THINK HARD</h1>
    
    <div class="debug-panel">
        <h3>ğŸ“‹ ë‹¨ê³„ë³„ ë””ë²„ê¹…</h3>
        <button class="btn-primary" onclick="step1_checkBasicState()">1ï¸âƒ£ ê¸°ë³¸ ìƒíƒœ í™•ì¸</button>
        <button class="btn-primary" onclick="step2_checkParcelData()">2ï¸âƒ£ í•„ì§€ ë°ì´í„° í™•ì¸</button>
        <button class="btn-primary" onclick="step3_testSaveProcess()">3ï¸âƒ£ ì €ì¥ ê³¼ì • í…ŒìŠ¤íŠ¸</button>
        <button class="btn-primary" onclick="step4_forceCreateMarker()">4ï¸âƒ£ ê°•ì œ M ë§ˆì»¤ ìƒì„±</button>
        <button class="btn-warning" onclick="step5_scanAllMarkers()">5ï¸âƒ£ ëª¨ë“  ë§ˆì»¤ ìŠ¤ìº”</button>
        <button class="btn-danger" onclick="clearDebug()">ğŸ”„ í´ë¦¬ì–´</button>
    </div>
    
    <div class="debug-panel">
        <h3>ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h3>
        <button class="btn-success" onclick="startMonitoring()">ğŸ” ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button class="btn-warning" onclick="stopMonitoring()">â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
        <div id="monitoring-status"></div>
    </div>
    
    <div class="debug-panel">
        <h3>ğŸ” ê²°ê³¼</h3>
        <pre id="debug-output"></pre>
    </div>
    
    <script>
        let monitoringInterval = null;
        let mainWindow = null;
        
        function log(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearDebug() {
            document.getElementById('debug-output').textContent = '';
            document.getElementById('monitoring-status').textContent = '';
        }
        
        function getMainWindow() {
            if (!mainWindow || mainWindow.closed) {
                // ìƒˆ ì°½ì—ì„œ ë©”ì¸ í˜ì´ì§€ ì—´ê¸°
                mainWindow = window.open('http://localhost:3000', 'mainApp', 'width=1200,height=800');
                log('ë©”ì¸ í˜ì´ì§€ë¥¼ ìƒˆ ì°½ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤. 4ì´ˆ í›„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
                return null;
            }
            return mainWindow;
        }
        
        function step1_checkBasicState() {
            log('ğŸ¯ 1ë‹¨ê³„: ê¸°ë³¸ ìƒíƒœ í™•ì¸ ì‹œì‘', 'info');
            
            const win = getMainWindow();
            if (!win) return;
            
            setTimeout(() => {
                try {
                    // AppState í™•ì¸
                    if (win.AppState) {
                        log('âœ… AppState ì¡´ì¬', 'success');
                        log(`ğŸ“ ì§€ë„ ê°ì²´: ${!!win.AppState.map}`, 'info');
                        log(`ğŸ“Š í´ë¦­ í•„ì§€ ìˆ˜: ${win.AppState.clickParcels?.size || 0}`, 'info');
                        log(`ğŸ¨ ìƒ‰ì¹  ëª¨ë“œ: ${win.AppState.paintMode}`, 'info');
                        log(`ğŸ” ê²€ìƒ‰ ëª¨ë“œ: ${win.AppState.searchMode}`, 'info');
                        
                        // í•„ìˆ˜ í•¨ìˆ˜ í™•ì¸
                        const functions = ['saveCurrentParcel', 'createMMarker', 'handleMapLeftClick'];
                        functions.forEach(func => {
                            const exists = typeof win[func] === 'function';
                            log(`${exists ? 'âœ…' : 'âŒ'} ${func} í•¨ìˆ˜: ${exists}`, exists ? 'success' : 'error');
                        });
                        
                    } else {
                        log('âŒ AppStateê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                    }
                } catch (error) {
                    log(`âŒ ê¸°ë³¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function step2_checkParcelData() {
            log('ğŸ¯ 2ë‹¨ê³„: í•„ì§€ ë°ì´í„° í™•ì¸ ì‹œì‘', 'info');
            
            const win = getMainWindow();
            if (!win) return;
            
            setTimeout(() => {
                try {
                    if (!win.AppState || !win.AppState.clickParcels) {
                        log('âŒ AppState.clickParcelsê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                        return;
                    }
                    
                    const parcels = Array.from(win.AppState.clickParcels.entries());
                    log(`ğŸ“‹ ì „ì²´ í´ë¦­ í•„ì§€ ìˆ˜: ${parcels.length}`, 'info');
                    
                    parcels.forEach(([pnu, parcelData], index) => {
                        log(`\\n--- í•„ì§€ ${index + 1}: ${pnu} ---`, 'info');
                        log(`  ğŸ“ ì§€ë²ˆ: ${parcelData.data?.jibun || 'N/A'}`, 'info');
                        log(`  ğŸ’¾ ì €ì¥ë¨: ${parcelData.data?.isSaved || false}`, parcelData.data?.isSaved ? 'success' : 'warning');
                        log(`  ğŸ…¼ ë§ˆì»¤ í”Œë˜ê·¸: ${parcelData.hasMarker || false}`, parcelData.hasMarker ? 'success' : 'warning');
                        log(`  ğŸ…¼ ë§ˆì»¤ ê°ì²´: ${!!parcelData.marker}`, parcelData.marker ? 'success' : 'error');
                        log(`  ğŸ“ ì§€ì˜¤ë©”íŠ¸ë¦¬: ${!!parcelData.data?.geometry}`, parcelData.data?.geometry ? 'success' : 'error');
                        
                        if (parcelData.marker) {
                            const isVisible = parcelData.marker.getMap() !== null;
                            log(`  ğŸ‘ï¸ ë§ˆì»¤ í‘œì‹œë¨: ${isVisible}`, isVisible ? 'success' : 'error');
                        }
                    });
                    
                } catch (error) {
                    log(`âŒ í•„ì§€ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function step3_testSaveProcess() {
            log('ğŸ¯ 3ë‹¨ê³„: ì €ì¥ ê³¼ì • í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            
            const win = getMainWindow();
            if (!win) return;
            
            setTimeout(() => {
                try {
                    // ì €ì¥í•  í•„ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (!win.AppState.currentSelectedParcel) {
                        log('âŒ í˜„ì¬ ì„ íƒëœ í•„ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•„ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.', 'error');
                        return;
                    }
                    
                    const parcelPNU = win.AppState.currentSelectedParcel;
                    const parcelData = win.AppState.clickParcels.get(parcelPNU);
                    
                    log(`ğŸ“ ì„ íƒëœ í•„ì§€: ${parcelPNU}`, 'info');
                    log(`ğŸ“ ì§€ë²ˆ: ${parcelData?.data?.jibun}`, 'info');
                    
                    // ì„ì‹œ ì •ë³´ ì…ë ¥
                    const ownerInput = win.document.getElementById('ownerName');
                    const memoInput = win.document.getElementById('memo');
                    
                    if (ownerInput) ownerInput.value = 'ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸';
                    if (memoInput) memoInput.value = 'M ë§ˆì»¤ í…ŒìŠ¤íŠ¸';
                    
                    log('ğŸ“ ì„ì‹œ ì •ë³´ ì…ë ¥ ì™„ë£Œ', 'success');
                    
                    // ì €ì¥ ì „ ìƒíƒœ ê¸°ë¡
                    const beforeSave = {
                        isSaved: parcelData?.data?.isSaved || false,
                        hasMarker: parcelData?.hasMarker || false,
                        markerExists: !!parcelData?.marker
                    };
                    
                    log('ğŸ’¾ ì €ì¥ ì „ ìƒíƒœ:', 'info');
                    log(`  - isSaved: ${beforeSave.isSaved}`, 'info');
                    log(`  - hasMarker: ${beforeSave.hasMarker}`, 'info');
                    log(`  - markerExists: ${beforeSave.markerExists}`, 'info');
                    
                    // ì €ì¥ ì‹¤í–‰
                    log('ğŸ’¾ ì €ì¥ ì‹¤í–‰...', 'warning');
                    win.saveCurrentParcel();
                    
                    // ì €ì¥ í›„ ìƒíƒœ í™•ì¸ (1ì´ˆ í›„)
                    setTimeout(() => {
                        const afterParcelData = win.AppState.clickParcels.get(parcelPNU);
                        const afterSave = {
                            isSaved: afterParcelData?.data?.isSaved || false,
                            hasMarker: afterParcelData?.hasMarker || false,
                            markerExists: !!afterParcelData?.marker
                        };
                        
                        log('ğŸ’¾ ì €ì¥ í›„ ìƒíƒœ:', 'info');
                        log(`  - isSaved: ${afterSave.isSaved} (${beforeSave.isSaved} â†’ ${afterSave.isSaved})`, afterSave.isSaved ? 'success' : 'error');
                        log(`  - hasMarker: ${afterSave.hasMarker} (${beforeSave.hasMarker} â†’ ${afterSave.hasMarker})`, afterSave.hasMarker ? 'success' : 'error');
                        log(`  - markerExists: ${afterSave.markerExists} (${beforeSave.markerExists} â†’ ${afterSave.markerExists})`, afterSave.markerExists ? 'success' : 'error');
                        
                        if (afterParcelData?.marker) {
                            const isVisible = afterParcelData.marker.getMap() !== null;
                            log(`  - ë§ˆì»¤ í‘œì‹œë¨: ${isVisible}`, isVisible ? 'success' : 'error');
                        }
                        
                        // ê²°ë¡ 
                        if (afterSave.isSaved && afterSave.hasMarker && afterSave.markerExists) {
                            log('ğŸ‰ ì €ì¥ ë° M ë§ˆì»¤ ìƒì„± ì„±ê³µ!', 'success');
                        } else {
                            log('âŒ ì €ì¥ ë˜ëŠ” M ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨!', 'error');
                        }
                        
                    }, 1000);
                    
                } catch (error) {
                    log(`âŒ ì €ì¥ ê³¼ì • í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function step4_forceCreateMarker() {
            log('ğŸ¯ 4ë‹¨ê³„: ê°•ì œ M ë§ˆì»¤ ìƒì„± ì‹œì‘', 'info');
            
            const win = getMainWindow();
            if (!win) return;
            
            setTimeout(() => {
                try {
                    const parcels = Array.from(win.AppState.clickParcels.entries());
                    if (parcels.length === 0) {
                        log('âŒ í´ë¦­ëœ í•„ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•„ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.', 'error');
                        return;
                    }
                    
                    // ì²« ë²ˆì§¸ í•„ì§€ì— ê°•ì œë¡œ M ë§ˆì»¤ ìƒì„±
                    const [pnu, parcelData] = parcels[0];
                    
                    log(`ğŸ…¼ ê°•ì œ M ë§ˆì»¤ ìƒì„± ì‹œë„: ${pnu}`, 'warning');
                    log(`  - ì§€ë²ˆ: ${parcelData.data?.jibun}`, 'info');
                    log(`  - ì§€ì˜¤ë©”íŠ¸ë¦¬: ${!!parcelData.data?.geometry}`, 'info');
                    
                    // ê¸°ì¡´ ë§ˆì»¤ í™•ì¸
                    if (parcelData.marker) {
                        log('ğŸ—‘ï¸ ê¸°ì¡´ ë§ˆì»¤ ì œê±°', 'warning');
                        parcelData.marker.setMap(null);
                    }
                    
                    // createMMarker ì§ì ‘ í˜¸ì¶œ
                    win.createMMarker(pnu);
                    
                    // ê²°ê³¼ í™•ì¸
                    setTimeout(() => {
                        const updatedData = win.AppState.clickParcels.get(pnu);
                        const success = updatedData?.marker && updatedData.marker.getMap() !== null;
                        
                        log(`ğŸ…¼ ê°•ì œ M ë§ˆì»¤ ìƒì„± ê²°ê³¼: ${success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`, success ? 'success' : 'error');
                        
                        if (success) {
                            log('âœ… M ë§ˆì»¤ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                        } else {
                            log('âŒ M ë§ˆì»¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                            
                            // ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
                            if (!updatedData?.data?.geometry) {
                                log('  ì›ì¸: ì§€ì˜¤ë©”íŠ¸ë¦¬ ë°ì´í„° ì—†ìŒ', 'error');
                            } else if (!win.AppState.map) {
                                log('  ì›ì¸: ì§€ë„ ê°ì²´ ì—†ìŒ', 'error');
                            } else {
                                log('  ì›ì¸: ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜', 'error');
                            }
                        }
                        
                    }, 500);
                    
                } catch (error) {
                    log(`âŒ ê°•ì œ M ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function step5_scanAllMarkers() {
            log('ğŸ¯ 5ë‹¨ê³„: ëª¨ë“  ë§ˆì»¤ ìŠ¤ìº” ì‹œì‘', 'info');
            
            const win = getMainWindow();
            if (!win) return;
            
            setTimeout(() => {
                try {
                    // DOMì—ì„œ M ë§ˆì»¤ ìš”ì†Œ ì°¾ê¸°
                    const markerElements = win.document.querySelectorAll('[style*="M"][style*="background"]');
                    log(`ğŸ” DOMì—ì„œ ë°œê²¬ëœ M ë§ˆì»¤ ìš”ì†Œ: ${markerElements.length}ê°œ`, 'info');
                    
                    markerElements.forEach((element, index) => {
                        log(`  ë§ˆì»¤ ${index + 1}: ${element.textContent} (${element.style.background})`, 'info');
                    });
                    
                    // AppStateì—ì„œ ë§ˆì»¤ ê°ì²´ í™•ì¸
                    const parcels = Array.from(win.AppState.clickParcels.entries());
                    let visibleMarkers = 0;
                    let invisibleMarkers = 0;
                    
                    parcels.forEach(([pnu, parcelData]) => {
                        if (parcelData.marker) {
                            const isVisible = parcelData.marker.getMap() !== null;
                            if (isVisible) {
                                visibleMarkers++;
                                log(`âœ… ${pnu}: M ë§ˆì»¤ í‘œì‹œë¨`, 'success');
                            } else {
                                invisibleMarkers++;
                                log(`âŒ ${pnu}: M ë§ˆì»¤ ìˆ¨ê¹€ë¨`, 'error');
                            }
                        }
                    });
                    
                    log(`\\nğŸ“Š ë§ˆì»¤ ìŠ¤ìº” ê²°ê³¼:`, 'info');
                    log(`  - í‘œì‹œëœ M ë§ˆì»¤: ${visibleMarkers}ê°œ`, 'success');
                    log(`  - ìˆ¨ê¹€ëœ M ë§ˆì»¤: ${invisibleMarkers}ê°œ`, 'error');
                    log(`  - DOM ë§ˆì»¤ ìš”ì†Œ: ${markerElements.length}ê°œ`, 'info');
                    
                } catch (error) {
                    log(`âŒ ë§ˆì»¤ ìŠ¤ìº” ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        function startMonitoring() {
            if (monitoringInterval) {
                log('âš ï¸ ì´ë¯¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            log('ğŸ” ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...', 'info');
            document.getElementById('monitoring-status').innerHTML = '<span style="color: #28a745;">ğŸŸ¢ ëª¨ë‹ˆí„°ë§ ì¤‘...</span>';
            
            const win = getMainWindow();
            if (!win) return;
            
            monitoringInterval = setInterval(() => {
                try {
                    if (win.closed || !win.AppState) {
                        stopMonitoring();
                        return;
                    }
                    
                    const parcels = Array.from(win.AppState.clickParcels.entries());
                    const savedParcels = parcels.filter(([, data]) => data.data?.isSaved);
                    const markersWithFlag = parcels.filter(([, data]) => data.hasMarker);
                    const markersWithObject = parcels.filter(([, data]) => data.marker);
                    const visibleMarkers = parcels.filter(([, data]) => data.marker && data.marker.getMap() !== null);
                    
                    document.getElementById('monitoring-status').innerHTML = `
                        <span style="color: #28a745;">ğŸŸ¢ ëª¨ë‹ˆí„°ë§ ì¤‘...</span><br>
                        ğŸ“Š í•„ì§€: ${parcels.length}ê°œ | ì €ì¥ë¨: ${savedParcels.length}ê°œ<br>
                        ğŸ…¼ hasMarker: ${markersWithFlag.length}ê°œ | markerê°ì²´: ${markersWithObject.length}ê°œ | í‘œì‹œë¨: ${visibleMarkers.length}ê°œ
                    `;
                    
                } catch (error) {
                    log(`âŒ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: ${error.message}`, 'error');
                    stopMonitoring();
                }
            }, 2000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€', 'warning');
                document.getElementById('monitoring-status').innerHTML = '<span style="color: #dc3545;">ğŸ”´ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨</span>';
            }
        }
        
        // ì´ˆê¸° ë©”ì‹œì§€
        log('ğŸ¯ M ë§ˆì»¤ ë””ë²„ê¹… ë„êµ¬ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        log('ğŸ“‹ ë¨¼ì € ë©”ì¸ í˜ì´ì§€(http://localhost:3000)ì—ì„œ í•„ì§€ë¥¼ í´ë¦­í•œ í›„ ë””ë²„ê¹…ì„ ì‹œì‘í•˜ì„¸ìš”.', 'info');
        log('', 'info');
        
    </script>
</body>
</html>