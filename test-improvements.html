<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ê¸°í™” ê°œì„ ì‚¬í•­ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-section.success {
            border-color: #10b981;
            background: #f0fdf4;
        }
        .test-section.error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .test-section.warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 8px 8px 0;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-syncing { background: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        h1, h2 {
            color: #1f2937;
        }
        .info-box {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ë™ê¸°í™” ê°œì„ ì‚¬í•­ í…ŒìŠ¤íŠ¸</h1>
        <p>ê°œì„ ëœ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ì—ëŸ¬ ì²˜ë¦¬ ì‹œìŠ¤í…œì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
        
        <div class="info-box">
            <strong>ğŸ“‹ í…ŒìŠ¤íŠ¸ ëª©í‘œ:</strong>
            <ul>
                <li>í–¥ìƒëœ ì—°ê²° í…ŒìŠ¤íŠ¸ ë¡œì§ ê²€ì¦</li>
                <li>ì‚¬ìš©ì ì¹œí™”ì  ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸</li>
                <li>ì„¤ì • ê°€ì´ë“œ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸</li>
                <li>ì‹¤ì‹œê°„ ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="test-section" id="connectionTest">
            <h2>ğŸ” 1. ì—°ê²° í…ŒìŠ¤íŠ¸ ê°œì„  ê²€ì¦</h2>
            <p>ìƒˆë¡œìš´ ì¢…í•©ì ì¸ Supabase ì„¤ì • ê²€ì¦ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            
            <button onclick="testConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="testWithBadCredentials()">ì˜ëª»ëœ ì¸ì¦ ì •ë³´ í…ŒìŠ¤íŠ¸</button>
            
            <div class="result" id="connectionResult"></div>
        </div>
    </div>

    <div class="container">
        <div class="test-section" id="errorHandlingTest">
            <h2>ğŸš¨ 2. ì—ëŸ¬ ë©”ì‹œì§€ ê°œì„  ê²€ì¦</h2>
            <p>ë‹¤ì–‘í•œ ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
            
            <button onclick="simulateNetworkError()">ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜</button>
            <button onclick="simulateAuthError()">ì¸ì¦ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜</button>
            <button onclick="simulateSetupError()">ì„¤ì • ëˆ„ë½ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜</button>
            
            <div class="result" id="errorResult"></div>
        </div>
    </div>

    <div class="container">
        <div class="test-section" id="syncStatusTest">
            <h2>ğŸ“Š 3. ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
            <p>ì‹¤ì‹œê°„ ë™ê¸°í™” ìƒíƒœ ë° ì´ë²¤íŠ¸ ì‹œìŠ¤í…œì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
            
            <div>
                <strong>í˜„ì¬ ìƒíƒœ:</strong> 
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">í™•ì¸ ì¤‘...</span>
            </div>
            
            <button onclick="initDataManager()">DataManager ì´ˆê¸°í™”</button>
            <button onclick="checkSyncStatus()">ë™ê¸°í™” ìƒíƒœ í™•ì¸</button>
            <button onclick="runDiagnostics()">ì‹œìŠ¤í…œ ì§„ë‹¨ ì‹¤í–‰</button>
            
            <div class="result" id="statusResult"></div>
        </div>
    </div>

    <div class="container">
        <div class="test-section" id="setupGuideTest">
            <h2>ğŸ“– 4. ì„¤ì • ê°€ì´ë“œ ì ‘ê·¼ì„±</h2>
            <p>ìƒì„±ëœ ì„¤ì • ê°€ì´ë“œì˜ ì ‘ê·¼ì„±ê³¼ ìœ ìš©ì„±ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
            
            <button onclick="showSetupGuide()">ì„¤ì • ê°€ì´ë“œ í‘œì‹œ</button>
            <button onclick="validateGuideContent()">ê°€ì´ë“œ ë‚´ìš© ê²€ì¦</button>
            
            <div class="result" id="guideResult"></div>
        </div>
    </div>

    <!-- DataManager ë¡œë“œ -->
    <script src="/js/data-manager.js"></script>

    <script>
        let testDataManager = null;

        // ë™ê¸°í™” ìƒíƒœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('syncStatusChanged', (event) => {
            updateStatusDisplay(event.detail.status);
            logResult('statusResult', `ğŸ”„ ë™ê¸°í™” ìƒíƒœ ë³€ê²½: ${event.detail.prevStatus} â†’ ${event.detail.status}`);
        });

        window.addEventListener('syncError', (event) => {
            logResult('errorResult', 'ğŸš¨ ë™ê¸°í™” ì—ëŸ¬ ì´ë²¤íŠ¸ ê°ì§€:\n' + event.detail.userGuide);
        });

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatusDisplay(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            switch(status) {
                case 'synced':
                    indicator.classList.add('status-online');
                    text.textContent = 'ë™ê¸°í™” ì™„ë£Œ';
                    break;
                case 'syncing':
                    indicator.classList.add('status-syncing');
                    text.textContent = 'ë™ê¸°í™” ì¤‘...';
                    break;
                case 'offline':
                    indicator.classList.add('status-offline');
                    text.textContent = 'ì˜¤í”„ë¼ì¸';
                    break;
                case 'error':
                    indicator.classList.add('status-offline');
                    text.textContent = 'ì—ëŸ¬ ë°œìƒ';
                    break;
                default:
                    text.textContent = status;
            }
        }

        // ê²°ê³¼ ë¡œê¹…
        function logResult(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n\n`;
            element.scrollTop = element.scrollHeight;
        }

        // 1. ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testConnection() {
            logResult('connectionResult', 'ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                if (!testDataManager) {
                    testDataManager = new DataManager();
                }
                
                const result = await testDataManager.testSupabaseConnection();
                logResult('connectionResult', 'âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ:\n' + JSON.stringify(result, null, 2));
                
                document.getElementById('connectionTest').className = 'test-section success';
            } catch (error) {
                logResult('connectionResult', 'âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:\n' + error.message);
                document.getElementById('connectionTest').className = 'test-section error';
            }
        }

        async function testWithBadCredentials() {
            logResult('connectionResult', 'ğŸ” ì˜ëª»ëœ ì¸ì¦ ì •ë³´ë¡œ í…ŒìŠ¤íŠ¸...');
            
            // ì„ì‹œë¡œ ì˜ëª»ëœ DataManager ìƒì„±
            const badDataManager = new DataManager();
            badDataManager.SUPABASE_URL = 'https://invalid-url.supabase.co';
            badDataManager.SUPABASE_ANON_KEY = 'invalid-key';
            
            try {
                await badDataManager.testSupabaseConnection();
                logResult('connectionResult', 'â“ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ê³¼ - ì‹¤íŒ¨í•´ì•¼ í–ˆëŠ”ë° ì„±ê³µí•¨');
            } catch (error) {
                logResult('connectionResult', 'âœ… ì˜ˆìƒëœ ì‹¤íŒ¨:\n' + error.message);
            }
        }

        // 2. ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
        function simulateNetworkError() {
            logResult('errorResult', 'ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜...');
            
            const networkError = new Error('fetch failed');
            if (testDataManager) {
                const userGuide = testDataManager.createUserFriendlyError(networkError);
                logResult('errorResult', userGuide);
            }
        }

        function simulateAuthError() {
            logResult('errorResult', 'ğŸ” ì¸ì¦ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜...');
            
            const authError = new Error('401 Unauthorized');
            if (testDataManager) {
                const userGuide = testDataManager.createUserFriendlyError(authError);
                logResult('errorResult', userGuide);
            }
        }

        function simulateSetupError() {
            logResult('errorResult', 'âš™ï¸ ì„¤ì • ëˆ„ë½ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜...');
            
            const setupError = new Error('function secure_batch_insert does not exist');
            if (testDataManager) {
                const userGuide = testDataManager.createUserFriendlyError(setupError);
                logResult('errorResult', userGuide);
            }
        }

        // 3. ë™ê¸°í™” ìƒíƒœ í…ŒìŠ¤íŠ¸
        function initDataManager() {
            logResult('statusResult', 'ğŸš€ DataManager ì´ˆê¸°í™” ì¤‘...');
            
            if (window.dataManager) {
                testDataManager = window.dataManager;
                updateStatusDisplay(testDataManager.syncStatus);
                logResult('statusResult', 'âœ… ê¸°ì¡´ DataManager ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©');
            } else {
                testDataManager = new DataManager();
                logResult('statusResult', 'âœ… ìƒˆ DataManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');
            }
        }

        function checkSyncStatus() {
            if (!testDataManager) {
                logResult('statusResult', 'âŒ DataManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }
            
            const stats = testDataManager.getStats();
            logResult('statusResult', 'ğŸ“Š ë™ê¸°í™” í†µê³„:\n' + JSON.stringify(stats, null, 2));
        }

        async function runDiagnostics() {
            if (!testDataManager) {
                logResult('statusResult', 'âŒ DataManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                return;
            }
            
            logResult('statusResult', 'ğŸ” ì‹œìŠ¤í…œ ì§„ë‹¨ ì‹¤í–‰ ì¤‘...');
            
            try {
                const diagnostics = await testDataManager.runDiagnostics();
                logResult('statusResult', 'ğŸ¯ ì§„ë‹¨ ê²°ê³¼:\n' + JSON.stringify(diagnostics, null, 2));
            } catch (error) {
                logResult('statusResult', 'âŒ ì§„ë‹¨ ì‹¤í–‰ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // 4. ì„¤ì • ê°€ì´ë“œ í…ŒìŠ¤íŠ¸
        function showSetupGuide() {
            logResult('guideResult', 'ğŸ“– ì„¤ì • ê°€ì´ë“œ ë¡œë”© ì¤‘...');
            
            fetch('/SETUP-GUIDE.md')
                .then(response => response.text())
                .then(content => {
                    logResult('guideResult', 'âœ… ì„¤ì • ê°€ì´ë“œ ë¡œë“œ ì™„ë£Œ (ê¸¸ì´: ' + content.length + ' ë¬¸ì)\n\n--- ê°€ì´ë“œ ë¯¸ë¦¬ë³´ê¸° ---\n' + content.substring(0, 500) + '...');
                })
                .catch(error => {
                    logResult('guideResult', 'âŒ ì„¤ì • ê°€ì´ë“œ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                });
        }

        function validateGuideContent() {
            logResult('guideResult', 'ğŸ” ê°€ì´ë“œ ë‚´ìš© ê²€ì¦ ì¤‘...');
            
            fetch('/SETUP-GUIDE.md')
                .then(response => response.text())
                .then(content => {
                    const requiredSections = [
                        'Supabase í”„ë¡œì íŠ¸ ìƒì„±',
                        'ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •',
                        'API í‚¤ ì„¤ì •',
                        'ë¬¸ì œ í•´ê²°',
                        'setup-complete.sql'
                    ];
                    
                    const validationResults = [];
                    requiredSections.forEach(section => {
                        if (content.includes(section)) {
                            validationResults.push(`âœ… ${section} ì„¹ì…˜ ì¡´ì¬`);
                        } else {
                            validationResults.push(`âŒ ${section} ì„¹ì…˜ ëˆ„ë½`);
                        }
                    });
                    
                    logResult('guideResult', 'ğŸ“‹ ê°€ì´ë“œ ê²€ì¦ ê²°ê³¼:\n' + validationResults.join('\n'));
                })
                .catch(error => {
                    logResult('guideResult', 'âŒ ê°€ì´ë“œ ê²€ì¦ ì‹¤íŒ¨: ' + error.message);
                });
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            logResult('connectionResult', 'í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ. ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
            logResult('errorResult', 'ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ.');
            logResult('statusResult', 'ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì¤€ë¹„ ì™„ë£Œ.');
            logResult('guideResult', 'ì„¤ì • ê°€ì´ë“œ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ.');
            
            // ê¸°ì¡´ DataManagerê°€ ìˆìœ¼ë©´ ìë™ ì´ˆê¸°í™”
            setTimeout(() => {
                if (window.dataManager) {
                    testDataManager = window.dataManager;
                    updateStatusDisplay(testDataManager.syncStatus);
                    logResult('statusResult', 'ğŸ”„ ê¸°ì¡´ DataManager ìë™ ê°ì§€ë¨');
                }
            }, 1000);
        });
    </script>
</body>
</html>